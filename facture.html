<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur de Facture - CAPSLOCK</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><style>.cls-1{fill:%23f4d03f;}.cls-2{fill:%23333;stroke:%23333;stroke-width:2;fill:none;}.cls-3{fill:%23333;}</style></defs><polygon class='cls-1' points='45,10 50,20 60,20 52,28 55,38 45,33 35,38 38,28 30,20 40,20'/><polygon class='cls-1' points='70,25 73,30 78,30 75,33 76,38 70,35 64,38 65,33 62,30 67,30'/><polygon class='cls-1' points='58,45 61,50 66,50 63,53 64,58 58,55 52,58 53,53 50,50 55,50'/><rect class='cls-2' x='15' y='25' width='45' height='60' rx='3'/><rect class='cls-3' x='20' y='35' width='25' height='2'/><rect class='cls-3' x='20' y='45' width='20' height='2'/><rect class='cls-3' x='20' y='55' width='25' height='2'/><rect class='cls-3' x='20' y='65' width='15' height='2'/><circle class='cls-2' cx='70' cy='60' r='15'/><text x='70' y='67' text-anchor='middle' class='cls-3' font-family='Arial' font-size='16' font-weight='bold'>$</text><path class='cls-2' d='M15,80 Q15,85 20,85 L75,85 Q80,85 80,80 L80,75 L15,75 Z'/></svg>" type="image/svg+xml">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f7fafd; margin: 0; padding: 0; color: #222; }
    .container { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); padding: 32px 24px; display: flex; gap: 40px; align-items: flex-start; }
    .form-section { flex: 1; min-width: 320px; }
    .facture-section { flex: 2; background: #f4f8fb; border-radius: 12px; padding: 24px 32px; min-width: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: sticky; top: 20px; max-height: calc(100vh - 60px); overflow-y: auto; }
    h1 { color: #1a7ee7; font-size: 2.1rem; margin-bottom: 18px; letter-spacing: 1px; }
    label { font-weight: 500; margin-top: 12px; display: block; }
    input, textarea, select { width: 100%; padding: 8px 10px; margin-top: 4px; margin-bottom: 10px; border: 1px solid #c7e0f7; border-radius: 6px; font-size: 1rem; font-family: inherit; background: #fafdff; transition: border 0.2s; }
    input[type="file"] { padding: 4px; background: #fff; cursor: pointer; }
    input[type="checkbox"] { width: auto; margin-right: 8px; cursor: pointer; }
    input:disabled { background: #f5f5f5; color: #999; border: 1px solid #ddd; cursor: not-allowed; }
    input:focus, textarea:focus { border: 1.5px solid #1a7ee7; outline: none; }
    .btn { background: #1a7ee7; color: #fff; border: none; border-radius: 6px; padding: 10px 22px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 8px rgba(26,126,231,0.08); transition: background 0.2s; }
    .btn:hover { background: #1766b8; }
    .prestations-list { margin-bottom: 10px; }
    .prest-item { background: #eaf4fb; border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 0.98rem; }
    .prest-item span { flex: 1; }
    .prest-item button { background: none; border: none; color: #e74c3c; font-size: 1.2rem; cursor: pointer; margin-left: 8px; }
    @media (max-width: 900px) { .container { flex-direction: column; } .facture-section { min-width: unset; position: relative; top: auto; max-height: none; overflow-y: visible; } }
    .facture { background: #fff; border-radius: 10px; padding: 28px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); color: #222; font-size: 0.75rem; max-width: 700px; margin: auto; }
    .facture-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
    .facture-title { font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, #ff6b9d, #c44569, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 1px; text-align: right; }
    .facture-info { font-size: 0.8rem; color: #222; margin-bottom: 4px; text-align: right; }
    .facture-emetteur { font-size: 0.8rem; color: #222; margin-bottom: 10px; font-weight: 400; line-height: 1.5; }
    .facture-client-box { background: #f4f4f4; border: 1.5px solid #e3eaf1; border-radius: 6px; padding: 14px 18px; margin: 24px 0 18px 0; }
    .facture-client-box b { font-size: 0.9rem; letter-spacing: 0.5px; }
    .facture-table { width: 100%; border-collapse: collapse; margin: 18px 0 10px 0; background: #fff; }
    .facture-table th, .facture-table td { border: 1px solid #222; padding: 6px 8px; text-align: left; font-size: 0.7rem; }
    .facture-table th { background: #f4f4f4; font-weight: 700; text-align: center; }
    .facture-table td { vertical-align: top; }
    .facture-total { text-align: right; font-size: 0.85rem; font-weight: 700; margin-top: 10px; margin-bottom: 10px; }
    .facture-paiement-box { background: #f4f4f4; border: 1.5px solid #e3eaf1; border-radius: 6px; padding: 14px 18px; margin: 28px 0 18px 0; }
    .facture-paiement-box b { font-size: 0.8rem; }
    .mentions { font-size: 0.7rem; color: #222; margin-top: 24px; border-top: 1px solid #e3eaf1; padding-top: 12px; }
    .facture-footer { margin-top: 18px; font-size: 0.98rem; }
    .section-highlight { animation: highlight-pulse 2s ease-in-out; }
    @keyframes highlight-pulse { 0% { box-shadow: 0 0 0 0 rgba(26, 126, 231, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(26, 126, 231, 0.2); } 100% { box-shadow: 0 0 0 0 rgba(26, 126, 231, 0); } }
    .sync-indicator { position: fixed; top: 20px; right: 20px; background: #1a7ee7; color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .sync-indicator.show { opacity: 1; }
    .sync-indicator::before { content: "üìç"; margin-right: 5px; }
    
    /* Toggle Devis/Facture */
    .mode-toggle-container { 
      display: flex; 
      justify-content: center; 
      margin: 20px auto 30px auto; 
      padding: 20px 0;
      background: linear-gradient(135deg, #f7fafd 0%, #e8f4fd 100%);
      border-bottom: 1px solid #e1ecf7;
    }
    .mode-toggle { position: relative; display: inline-block; }
    .mode-toggle-checkbox { display: none; }
    .mode-toggle-label { 
      display: block; 
      overflow: hidden; 
      cursor: pointer; 
      border: 2px solid #1a7ee7; 
      border-radius: 25px; 
      position: relative; 
      box-shadow: 0 4px 12px rgba(26, 126, 231, 0.15);
      transition: all 0.3s ease;
    }
    .mode-toggle-label:hover {
      box-shadow: 0 6px 20px rgba(26, 126, 231, 0.25);
      transform: translateY(-2px);
    }
    .mode-toggle-inner { 
      display: block; 
      width: 200%; 
      margin-left: -100%; 
      transition: margin 0.3s ease-in-out;
    }
    .mode-toggle-inner:before, .mode-toggle-inner:after { 
      display: block; 
      float: left; 
      width: 50%; 
      height: 40px; 
      padding: 0; 
      line-height: 40px; 
      font-size: 14px; 
      font-weight: 700; 
      color: white; 
      font-family: 'Montserrat', sans-serif; 
      box-sizing: border-box; 
    }
    .mode-toggle-inner:before { 
      content: "DEVIS"; 
      padding-left: 18px; 
      background: linear-gradient(135deg, #1a7ee7, #0f5bb8); 
      color: #FFFFFF; 
    }
    .mode-toggle-inner:after { 
      content: "FACTURE"; 
      padding-right: 18px; 
      background: linear-gradient(135deg, #e74c3c, #c0392b); 
      color: #FFFFFF; 
      text-align: right; 
    }
    .mode-toggle-switch { 
      display: block; 
      width: 24px; 
      height: 24px; 
      margin: 8px; 
      background: #FFFFFF; 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      right: 120px; 
      border: 2px solid #1a7ee7; 
      border-radius: 50%; 
      transition: all 0.3s ease-in-out; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .mode-toggle-checkbox:checked + .mode-toggle-label .mode-toggle-inner { margin-left: 0; }
    .mode-toggle-checkbox:checked + .mode-toggle-label .mode-toggle-switch { right: 8px; border-color: #e74c3c; }
    .mode-labels { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 8px; 
      font-size: 0.85rem; 
      font-weight: 600; 
      color: #666; 
    }
    .mode-label-left, .mode-label-right { width: 80px; text-align: center; }
    .mode-toggle-checkbox:checked ~ .mode-labels .mode-label-left { color: #bbb; }
    .mode-toggle-checkbox:checked ~ .mode-labels .mode-label-right { color: #e74c3c; }
    .mode-toggle-checkbox:not(:checked) ~ .mode-labels .mode-label-left { color: #1a7ee7; }
    .mode-toggle-checkbox:not(:checked) ~ .mode-labels .mode-label-right { color: #bbb; }
    
    @media print { body, html { background: #fff !important; } .container { box-shadow: none !important; background: #fff !important; padding: 0 !important; margin: 0 !important; display: block !important; } .form-section, .prestations-list, .btn, .mode-toggle-container { display: none !important; } .facture-section { background: #fff !important; box-shadow: none !important; padding: 0 !important; min-width: unset !important; } .facture { box-shadow: none !important; margin: 0 auto !important; max-width: 100% !important; color: #222 !important; background: #fff !important; page-break-after: avoid; } }
  </style>
</head>
<body>
  <!-- Toggle Devis/Facture -->
  <div class="mode-toggle-container">
    <div class="mode-toggle">
      <input type="checkbox" id="modeToggle" class="mode-toggle-checkbox">
      <label for="modeToggle" class="mode-toggle-label">
        <span class="mode-toggle-inner"></span>
        <span class="mode-toggle-switch"></span>
      </label>
      <div class="mode-labels">
        <span class="mode-label-left">DEVIS</span>
        <span class="mode-label-right">FACTURE</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sync-indicator" id="syncIndicator">Aper√ßu synchronis√©</div>
    <div class="form-section">
      <h1 id="mainTitle">Nouveau devis</h1>
      <form id="factureForm" autocomplete="off" onsubmit="return false;">
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations √©metteur</h3>
        <label>Logo de l'entreprise (optionnel)</label>
        <input type="file" id="logoEntreprise" accept="image/*" onchange="chargerLogo()">
        <div id="logoPreview" style="margin-top: 10px; display: none;">
          <img id="logoImage" style="max-width: 100px; max-height: 60px; border: 1px solid #ddd; border-radius: 4px;">
          <button type="button" onclick="supprimerLogo()" style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Supprimer</button>
        </div>
        <label>Statut juridique</label>
        <select id="statutJuridique" onchange="changerStatut()" required>
          <option value="micro">Micro-entreprise</option>
          <option value="sasu">SASU</option>
          <option value="eurl">EURL</option>
        </select>
        <label>Nom de l'entreprise</label>
        <input type="text" id="emetteurNom" value="" required>
        <label>Contact</label>
        <input type="text" id="emetteurContact" value="" required>
        <label>Adresse</label>
        <input type="text" id="emetteurAdresse" placeholder="Num√©ro et nom de rue" required>
        <label>Code postal</label>
        <input type="text" id="emetteurCodePostal" placeholder="Code postal" required>
        <label>Ville</label>
        <input type="text" id="emetteurVille" placeholder="Ville" required>
        <label>SIRET</label>
        <input type="text" id="emetteurSiret" value="" required>
        <div id="champsMicroRcs" style="display: none;">
          <label>
            <input type="checkbox" id="microAUnRcs" onchange="changerAffichageRcsMicro()"> 
            Avez-vous un RCS ? (cochez si vous faites du commerce)
          </label>
        </div>
        <div id="champsRcsStandard">
          <label>RCS</label>
          <input type="text" id="emetteurRcs" value="" required>
          <label>Ville RCS</label>
          <input type="text" id="emetteurVilleRcs" placeholder="Ville d'immatriculation" required>
        </div>
        <div id="champsSasu" style="display: none;">
          <label>Pr√©sident</label>
          <input type="text" id="presidentSasu" placeholder="Pr√©nom NOM">
          <label>Capital social (‚Ç¨)</label>
          <input type="number" id="capitalSocial" min="0" step="0.01">
          <label>N¬∞ TVA intracommunautaire</label>
          <input type="text" id="numTva" placeholder="FR12345678901">
          <label>Date de cr√©ation SASU</label>
          <input type="date" id="dateCreationSasu">
        </div>
        <div id="champsEurl" style="display: none;">
          <label>Capital social EURL (‚Ç¨)</label>
          <input type="number" id="capitalSocialEurl" min="0" step="0.01">
          <label>N¬∞ TVA intracommunautaire</label>
          <input type="text" id="numTvaEurl" placeholder="FR12345678901">
          <label>Date de cr√©ation EURL</label>
          <input type="date" id="dateCreationEurl">
          <label>G√©rant</label>
          <input type="text" id="gerantEurl" placeholder="Nom du g√©rant">
          <label>Associ√© unique</label>
          <input type="text" id="associeUniqueEurl" placeholder="Nom de l'associ√© unique">
        </div>
        <label>Email</label>
        <input type="email" id="emetteurEmail" value="" required>
        <label>T√©l√©phone</label>
        <input type="tel" id="emetteurTel" value="" required>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;" id="infoDocumentTitle">Informations devis</h3>
        <label id="numeroDocumentLabel">Num√©ro de devis</label>
        <input type="text" id="numFacture" value="D001" required>
        <label id="dateDocumentLabel">Date</label>
        <input type="date" id="dateFacture" required>
        <div id="devisValidite" style="display: block;">
          <label>Validit√© du devis (jours)</label>
          <input type="number" id="validiteDevis" value="30" min="1" max="365" required>
        </div>
        <div id="devisAcompte" style="display: block;">
          <label>
            <input type="checkbox" id="demanderAcompte" onchange="changerAffichageAcompte()"> 
            Voulez-vous demander un acompte ?
          </label>
          <div id="champsAcompte" style="display: none; margin-top: 10px;">
            <label>Pourcentage d'acompte (%)</label>
            <input type="number" id="pourcentageAcompte" value="40" min="10" max="90" step="5" onchange="majApercu()">
          </div>
        </div>
        <div id="devisPlanning" style="display: block;">
          <label>D√©marrage (texte libre)</label>
          <input type="text" id="demarrageDevis" value="2 semaines apr√®s signature" placeholder="Ex: 1 semaine apr√®s validation">
          <label>Dur√©e estim√©e (texte libre)</label>
          <input type="text" id="dureeEstimee" value="" placeholder="Ex: 5 jours ouvr√©s, 2 semaines, 1 mois...">
        </div>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations client</h3>
        <label>Nom du client</label>
        <input type="text" id="clientNom" required>
        <label>Adresse du client</label>
        <input type="text" id="clientAdresse" required>
        <label>Code postal & Ville</label>
        <input type="text" id="clientVille" required>
        <label>SIRET du client (optionnel)</label>
        <input type="text" id="clientSiret">
        <div id="champsClientSasu" style="display: none;">
          <label>N¬∞ TVA client (optionnel)</label>
          <input type="text" id="clientTva" placeholder="FR12345678901">
        </div>
        <label>P√©riode factur√©e</label>
        <input type="text" id="periode" value="Juillet 2025" required>
        <label>Date de prestation</label>
        <input type="date" id="datePrestation" required>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Prestations</h3>
        <label>Ajouter une prestation</label>
        <input type="text" id="titrePresta" placeholder="Titre de la t√¢che">
        <input type="text" id="descPresta" placeholder="Description d√©taill√©e">
        <div style="display: flex; gap: 10px;">
          <input type="number" id="prixHT" placeholder="Prix HT (‚Ç¨)" min="0" step="0.01" style="flex: 1;" oninput="calculerTTCDepuisHT()">
          <input type="number" id="prixPresta" placeholder="Prix TTC (‚Ç¨)" min="0" step="0.01" style="flex: 1;" oninput="calculerHTDepuisTTC()" disabled>
        </div>
        <div id="infoTVA" style="font-size: 0.9rem; color: #666; margin-top: 5px; display: none;">
          Le prix TTC n'est pas calcul√© pour les micro entreprises au vu de leur statut juridique.
        </div>
        <div id="infoMicro" style="font-size: 0.9rem; color: #666; margin-top: 5px;">
          Pour les micro-entreprises : saisissez uniquement le prix HT (TVA non applicable).
        </div>
        <input type="number" id="qtePresta" placeholder="Quantit√©" min="1" step="1">
        <button class="btn" type="button" onclick="ajouterPrestation()">Ajouter</button>
        <div class="prestations-list" id="prestationsList"></div>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations bancaires</h3>
        <label>Mode de paiement</label>
        <select id="modePaiement" required>
          <option value="virement">Virement bancaire</option>
          <option value="cheque">Ch√®que</option>
          <option value="carte">Carte bancaire</option>
          <option value="espece">Esp√®ce</option>
        </select>
        <label>IBAN</label>
        <input type="text" id="iban" value="" required>
        <label>BIC</label>
        <input type="text" id="bic" value="" required>
        <label>Banque</label>
        <input type="text" id="banque" value="" required>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button class="btn" type="button" onclick="imprimerDocument()" id="btnImprimer">Enregistrer en PDF</button>
          <button class="btn" type="button" onclick="exporterCSV()" style="background-color: #27ae60;" id="btnExporter">Exporter en CSV</button>
        </div>
      </form>
    </div>
    <div class="facture-section">
      <div id="factureApercu" class="facture"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="config.js"></script>
  <script>
    let prestations = [];
    let logoEntrepriseData = null;
    let isFactureMode = false; // false = devis, true = facture
    
    function chargerLogo() {
      const fileInput = document.getElementById('logoEntreprise');
      const file = fileInput.files[0];
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          logoEntrepriseData = e.target.result;
          document.getElementById('logoImage').src = logoEntrepriseData;
          document.getElementById('logoPreview').style.display = 'block';
          majApercu();
        };
        reader.readAsDataURL(file);
      }
    }
    
    function supprimerLogo() {
      logoEntrepriseData = null;
      document.getElementById('logoEntreprise').value = '';
      document.getElementById('logoPreview').style.display = 'none';
      majApercu();
    }
    
    function toggleMode() {
      const modeToggle = document.getElementById('modeToggle');
      isFactureMode = modeToggle.checked;
      
      // Mise √† jour des libell√©s
      const mainTitle = document.getElementById('mainTitle');
      const infoDocumentTitle = document.getElementById('infoDocumentTitle');
      const numeroDocumentLabel = document.getElementById('numeroDocumentLabel');
      const dateDocumentLabel = document.getElementById('dateDocumentLabel');
      const devisValidite = document.getElementById('devisValidite');
      const devisAcompte = document.getElementById('devisAcompte');
      const btnImprimer = document.getElementById('btnImprimer');
      const btnExporter = document.getElementById('btnExporter');
      const numFacture = document.getElementById('numFacture');
      
      if (isFactureMode) {
        // Mode Facture
        mainTitle.textContent = 'Nouvelle facture';
        infoDocumentTitle.textContent = 'Informations facture';
        numeroDocumentLabel.textContent = 'Num√©ro de facture';
        dateDocumentLabel.textContent = 'Date';
        devisValidite.style.display = 'none';
        devisAcompte.style.display = 'none';
        document.getElementById('devisPlanning').style.display = 'none';
        btnImprimer.textContent = 'Enregistrer facture en PDF';
        btnExporter.textContent = 'Exporter facture en CSV';
        if (numFacture.value.startsWith('D')) {
          numFacture.value = 'F' + numFacture.value.substring(1);
        }
      } else {
        // Mode Devis
        mainTitle.textContent = 'Nouveau devis';
        infoDocumentTitle.textContent = 'Informations devis';
        numeroDocumentLabel.textContent = 'Num√©ro de devis';
        dateDocumentLabel.textContent = 'Date';
        devisValidite.style.display = 'block';
        devisAcompte.style.display = 'block';
        document.getElementById('devisPlanning').style.display = 'block';
        btnImprimer.textContent = 'Enregistrer devis en PDF';
        btnExporter.textContent = 'Exporter devis en CSV';
        if (numFacture.value.startsWith('F')) {
          numFacture.value = 'D' + numFacture.value.substring(1);
        }
      }
      
      majApercu();
    }
    
    function changerAffichageAcompte() {
      const demanderAcompte = document.getElementById('demanderAcompte').checked;
      const champsAcompte = document.getElementById('champsAcompte');
      
      if (demanderAcompte) {
        champsAcompte.style.display = 'block';
      } else {
        champsAcompte.style.display = 'none';
      }
      
      majApercu();
    }
    
    function changerStatut() {
      const statut = document.getElementById('statutJuridique').value;
      const champsSasu = document.getElementById('champsSasu');
      const champsEurl = document.getElementById('champsEurl');
      const champsClientSasu = document.getElementById('champsClientSasu');
      const champsMicroRcs = document.getElementById('champsMicroRcs');
      const champsRcsStandard = document.getElementById('champsRcsStandard');
      const prixTTCInput = document.getElementById('prixPresta');
      const infoTVA = document.getElementById('infoTVA');
      const infoMicro = document.getElementById('infoMicro');
      
      if (statut === 'sasu') {
        champsSasu.style.display = 'block';
        champsEurl.style.display = 'none';
        champsClientSasu.style.display = 'block';
        champsMicroRcs.style.display = 'none';
        champsRcsStandard.style.display = 'block';
        prixTTCInput.disabled = false;
        infoTVA.style.display = 'block';
        infoMicro.style.display = 'none';
        
        // R√©initialiser les champs RCS pour SASU
        const emetteurRcs = document.getElementById('emetteurRcs');
        const emetteurVilleRcs = document.getElementById('emetteurVilleRcs');
        if (emetteurRcs.value === 'Dispens√© d\'immatriculation au RCS') {
          emetteurRcs.value = '';
        }
        emetteurRcs.required = true;
        emetteurVilleRcs.required = true;
        
      } else if (statut === 'eurl') {
        champsSasu.style.display = 'none';
        champsEurl.style.display = 'block';
        champsClientSasu.style.display = 'block';
        champsMicroRcs.style.display = 'none';
        champsRcsStandard.style.display = 'block';
        prixTTCInput.disabled = false;
        infoTVA.style.display = 'block';
        infoMicro.style.display = 'none';
        
        // R√©initialiser les champs RCS pour EURL
        const emetteurRcs = document.getElementById('emetteurRcs');
        const emetteurVilleRcs = document.getElementById('emetteurVilleRcs');
        if (emetteurRcs.value === 'Dispens√© d\'immatriculation au RCS') {
          emetteurRcs.value = '';
        }
        emetteurRcs.required = true;
        emetteurVilleRcs.required = true;
        
      } else {
        champsSasu.style.display = 'none';
        champsEurl.style.display = 'none';
        champsClientSasu.style.display = 'none';
        champsMicroRcs.style.display = 'block';
        champsRcsStandard.style.display = 'none';
        prixTTCInput.disabled = true;
        prixTTCInput.value = '';
        infoTVA.style.display = 'none';
        infoMicro.style.display = 'block';
        
        // Initialiser l'affichage des champs RCS pour micro-entreprise
        changerAffichageRcsMicro();
      }
      
      // Recalculer les prix dans les champs de saisie si des valeurs sont pr√©sentes
      const prixTTC = document.getElementById('prixPresta').value;
      const prixHT = document.getElementById('prixHT').value;
      
      if (prixTTC && !isNaN(parseFloat(prixTTC))) {
        calculerHTDepuisTTC();
      } else if (prixHT && !isNaN(parseFloat(prixHT))) {
        calculerTTCDepuisHT();
      }
      
      // Rafra√Æchir l'affichage des prestations avec les bons labels
      afficherPrestations();
      majApercu();
    }
    
    function changerAffichageRcsMicro() {
      const microAUnRcs = document.getElementById('microAUnRcs').checked;
      const champsRcsStandard = document.getElementById('champsRcsStandard');
      const emetteurRcs = document.getElementById('emetteurRcs');
      const emetteurVilleRcs = document.getElementById('emetteurVilleRcs');
      
      if (microAUnRcs) {
        // Afficher les champs RCS
        champsRcsStandard.style.display = 'block';
        emetteurRcs.value = '';
        emetteurVilleRcs.value = '';
        emetteurRcs.required = true;
        emetteurVilleRcs.required = true;
      } else {
        // Masquer les champs RCS et remplir automatiquement
        champsRcsStandard.style.display = 'none';
        emetteurRcs.value = 'Dispens√© d\'immatriculation au RCS';
        emetteurVilleRcs.value = '';
        emetteurRcs.required = false;
        emetteurVilleRcs.required = false;
      }
      
      majApercu();
    }
    
    function calculerTTCDepuisHT() {
      const prixHT = parseFloat(document.getElementById('prixHT').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      
      if (!isNaN(prixHT) && prixHT >= 0) {
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          const prixTTC = prixHT * 1.20; // TVA 20%
          document.getElementById('prixPresta').value = prixTTC.toFixed(2);
        } else {
          // Pour micro-entreprise, on ne calcule pas de TTC, on laisse vide
          document.getElementById('prixPresta').value = '';
        }
      } else if (prixHT === '' || isNaN(prixHT)) {
        document.getElementById('prixPresta').value = '';
      }
    }
    
    function calculerHTDepuisTTC() {
      const prixTTC = parseFloat(document.getElementById('prixPresta').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      
      if (!isNaN(prixTTC) && prixTTC >= 0) {
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          const prixHT = prixTTC / 1.20; // D√©duction TVA 20%
          document.getElementById('prixHT').value = prixHT.toFixed(2);
        } else {
          // Pour micro-entreprise, TTC = HT (pas de TVA)
          document.getElementById('prixHT').value = prixTTC.toFixed(2);
        }
      } else if (prixTTC === '' || isNaN(prixTTC)) {
        document.getElementById('prixHT').value = '';
      }
    }
    
    function ajouterPrestation() {
      const titre = document.getElementById('titrePresta').value.trim();
      const desc = document.getElementById('descPresta').value.trim();
      const prixTTC = parseFloat(document.getElementById('prixPresta').value);
      const prixHT = parseFloat(document.getElementById('prixHT').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      let qte = 1;
      if (document.getElementById('qtePresta')) {
        qte = parseInt(document.getElementById('qtePresta').value) || 1;
      }
      
      // V√©rifier qu'on a au moins un prix (HT ou TTC selon le statut)
      if (!titre || !desc) return;
      
      let prixFinal;
      if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
        // Pour SASU et EURL, on peut avoir HT ou TTC, on stocke le TTC
        if (!isNaN(prixTTC)) {
          prixFinal = prixTTC;
        } else if (!isNaN(prixHT)) {
          prixFinal = prixHT * 1.20; // Calculer TTC √† partir de HT
        } else {
          return; // Pas de prix saisi
        }
      } else {
        // Pour micro-entreprise, seul le HT compte
        if (!isNaN(prixHT)) {
          prixFinal = prixHT;
        } else if (!isNaN(prixTTC)) {
          prixFinal = prixTTC; // TTC = HT pour micro-entreprise
        } else {
          return; // Pas de prix saisi
        }
      }
      
      prestations.push({ titre, desc, prix: prixFinal, qte });
      document.getElementById('titrePresta').value = '';
      document.getElementById('descPresta').value = '';
      document.getElementById('prixPresta').value = '';
      document.getElementById('prixHT').value = '';
      if (document.getElementById('qtePresta')) document.getElementById('qtePresta').value = '';
      afficherPrestations();
      majApercu();
    }
    function supprimerPrestation(idx) {
      prestations.splice(idx, 1);
      afficherPrestations();
      majApercu();
    }
    function afficherPrestations() {
      const list = document.getElementById('prestationsList');
      const statutJuridique = document.getElementById('statutJuridique').value;
      list.innerHTML = '';
      prestations.forEach((p, i) => {
        let prixLabel;
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          prixLabel = `${p.prix.toFixed(2)} ‚Ç¨ TTC`;
        } else {
          prixLabel = `${p.prix.toFixed(2)} ‚Ç¨ HT`;
        }
        list.innerHTML += `<div class='prest-item'><span><b>${p.titre}</b><br>${p.desc} ‚Äî <b>${prixLabel}</b></span><button onclick='supprimerPrestation(${i})' title='Supprimer'>&times;</button></div>`;
      });
    }
    function majApercu() {
      const statutJuridique = document.getElementById('statutJuridique').value;
      const numFacture = document.getElementById('numFacture').value;
      const dateFacture = document.getElementById('dateFacture').value;
      const clientNom = document.getElementById('clientNom').value;
      const clientAdresse = document.getElementById('clientAdresse').value;
      const clientVille = document.getElementById('clientVille').value;
      const clientSiret = document.getElementById('clientSiret').value;
      const periode = document.getElementById('periode').value;
      const iban = document.getElementById('iban').value;
      const bic = document.getElementById('bic').value;
      const banque = document.getElementById('banque').value;
      const modePaiement = document.getElementById('modePaiement').value;
      const emetteurNom = document.getElementById('emetteurNom').value;
      const emetteurContact = document.getElementById('emetteurContact').value;
      const emetteurAdresse = document.getElementById('emetteurAdresse').value;
      const emetteurCodePostal = document.getElementById('emetteurCodePostal').value;
      const emetteurVille = document.getElementById('emetteurVille').value;
      const emetteurSiret = document.getElementById('emetteurSiret').value;
      const emetteurRcs = document.getElementById('emetteurRcs').value;
      const emetteurVilleRcs = document.getElementById('emetteurVilleRcs').value;
      const emetteurEmail = document.getElementById('emetteurEmail').value;
      const emetteurTel = document.getElementById('emetteurTel').value;
      
      let echeance = '';
      if (dateFacture) {
        const d = new Date(dateFacture);
        d.setDate(d.getDate() + 30);
        echeance = d.toLocaleDateString('fr-FR');
      }
      
      const totalPrix = prestations.reduce((acc, p) => acc + (p.prix * (p.qte || 1)), 0);
      
      if (isFactureMode) {
        // Mode Facture
        if (statutJuridique === 'sasu') {
          // Pour SASU, totalPrix = TTC
          genererFactureSASU(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        } else if (statutJuridique === 'eurl') {
          // Pour EURL, totalPrix = TTC
          genererFactureEURL(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        } else {
          // Pour micro-entreprise, totalPrix = HT
          genererFactureMicro(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        }
      } else {
        // Mode Devis
        const validiteDevis = document.getElementById('validiteDevis').value;
        if (statutJuridique === 'sasu') {
          // Pour SASU, totalPrix = TTC
          genererDevisSASU(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        } else if (statutJuridique === 'eurl') {
          // Pour EURL, totalPrix = TTC
          genererDevisEURL(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        } else {
          // Pour micro-entreprise, totalPrix = HT
          genererDevisMicro(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalPrix);
        }
      }
    }
    
    function genererFactureMicro(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalHT) {
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            <i style="font-size:0.9rem; color: #666;">Entrepreneur Individuel</i><br>
            ${emetteurContact}<br>
            ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br>
            SIRET : ${emetteurSiret}<br>
            ${emetteurRcs === 'Dispens√© d\'immatriculation au RCS' ? emetteurRcs : (emetteurVilleRcs ? `RCS ${emetteurVilleRcs} : ${emetteurRcs}` : emetteurRcs)}<br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N¬∞ <b>${numFacture || ''}</b></div>
            <div class="facture-info">Date : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">√âch√©ance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>FACTURER √Ä :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[NOM DU CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT si applicable]<br>'}
        </div>
        <table class="facture-table">
          <tr>
            <th>Description des prestations</th>
            <th>P√©riode</th>
            <th>Quantit√©</th>
            <th>Prix unit. HT</th>
            <th>Total HT</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='5' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix; // Pour micro-entreprise, le prix stock√© est HT
              const totalHT = prixHT * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalHT.toFixed(2)} ‚Ç¨</td></tr>`;
            }).join('')}
        </table>
        <div class="facture-total">Total HT : ${totalHT.toFixed(2)} ‚Ç¨<br>TVA : Non applicable<br><span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalHT.toFixed(2)} ‚Ç¨</span></div>
        <div class="facture-paiement-box">
          <b>MODALIT√âS DE PAIEMENT</b><br>
          √âch√©ance : 30 jours √† r√©ception<br>
          <b>Mode de paiement :</b> ${modePaiement === 'virement' ? 'Virement bancaire' : modePaiement === 'cheque' ? 'Ch√®que' : modePaiement === 'carte' ? 'Carte bancaire' : 'Esp√®ce'}<br>
          ${modePaiement === 'virement' ? `<b>RIB :</b><br>IBAN : ${iban || '[VOTRE IBAN]'}<br>BIC : ${bic || '[VOTRE BIC]'}<br>Banque : ${banque || '[NOM DE VOTRE BANQUE]'}` : ''}
        </div>
        <div class="mentions">
          <b>Mentions l√©gales obligatoires :</b><br>
          ‚Ä¢ TVA non applicable, art. 293 B du CGI<br>
          ‚Ä¢ En cas de retard de paiement, indemnit√© forfaitaire de recouvrement : 40 ‚Ç¨<br>
          ‚Ä¢ Taux de p√©nalit√© de retard : 3 fois le taux de l'int√©r√™t l√©gal<br>
          ‚Ä¢ Aucun escompte pour paiement anticip√©
        </div>
      `;
    }
    
    function genererDevisMicro(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalHT) {
      let dateEcheance = '';
      if (dateFacture && validiteDevis) {
        const d = new Date(dateFacture);
        d.setDate(d.getDate() + parseInt(validiteDevis));
        dateEcheance = d.toLocaleDateString('fr-FR');
      }
      
      // Gestion de l'acompte
      const demanderAcompte = document.getElementById('demanderAcompte').checked;
      const pourcentageAcompte = parseInt(document.getElementById('pourcentageAcompte').value) || 40;
      const montantAcompte = demanderAcompte ? (totalHT * pourcentageAcompte / 100) : 0;
      const solde = demanderAcompte ? (totalHT - montantAcompte) : totalHT;
      
      // Gestion du planning personnalis√©
      const demarrageDevis = document.getElementById('demarrageDevis').value || '2 semaines apr√®s signature';
      const dureeEstimee = document.getElementById('dureeEstimee').value || `${prestations.length > 0 ? Math.max(...prestations.map(p => p.qte || 1)) : 'X'} jour${prestations.length > 0 && Math.max(...prestations.map(p => p.qte || 1)) > 1 ? 's' : ''}`;
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.4rem;">${emetteurNom}</b><br>
            <i style="font-size:0.9rem; color: #666;">Entrepreneur Individuel</i><br>
            ${emetteurContact}<br><br>
            ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br><br>
            SIRET : ${emetteurSiret || '[√Ä COMPL√âTER]'}<br>
            ${emetteurRcs === 'Dispens√© d\'immatriculation au RCS' ? emetteurRcs : (emetteurVilleRcs ? `RCS ${emetteurVilleRcs} : ${emetteurRcs}` : emetteurRcs)}<br><br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">DEVIS</div>
            <div class="facture-info">N¬∞ <b>${numFacture || 'D001'}</b></div>
            <div class="facture-info">Date : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Projet : <b>${periode || '[NOM PROJET]'}</b></div>
          </div>
        </div>
        
        <div class="facture-client-box">
          <b>CLIENT :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[NOM DU CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE]<br>'}
          <br>Contact : [NOM CONTACT]<br>
          Email : [EMAIL CLIENT]<br>
          T√©l : [T√âL√âPHONE CLIENT]<br>
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : ''}
        </div>
        
        <div style="background: #fff3cd; border: 2px solid #f0ad4e; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
          <b style="font-size: 1.1rem; color: #8a6d3b;">‚è∞ DEVIS VALABLE ${validiteDevis || 30} JOURS</b><br>
          √Ä partir du ${dateFacture || '[DATE]'} jusqu'au ${dateEcheance || '[DATE + ' + (validiteDevis || 30) + ' jours]'}
        </div>
        
        <div style="margin: 20px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">PRESTATIONS PROPOS√âES :</b>
        </div>
        
        <table class="facture-table">
          <tr>
            <th style="width: 45%;">Description d√©taill√©e</th>
            <th style="width: 15%;">Dur√©e estim√©e</th>
            <th style="width: 8%;">Qt√©</th>
            <th style="width: 16%;">Prix unitaire</th>
            <th style="width: 16%;">Total</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='5' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix; // Pour micro-entreprise, le prix stock√© est HT
              const totalHT = prixHT * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}<br><i style="color: #666;">Livrable : Document d√©taill√©</i></td><td style='text-align:center;'>${p.qte || 1} jour${(p.qte || 1) > 1 ? 's' : ''}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalHT.toFixed(2)} ‚Ç¨</td></tr>`;
            }).join('')}
        </table>
        
        <div style="margin: 20px 0; text-align: right;">
          <div style="display: inline-block; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1a7ee7;">
            <b>TOTAL PRESTATIONS :</b><br>
            <span style="font-size: 1.1rem;">${totalHT.toFixed(2)} ‚Ç¨</span><br><br>
            <b>TVA :</b> Non applicable<br><br>
            <span style="font-size: 1.3rem; font-weight: 800; color: #1a7ee7;">TOTAL PROJET : ${totalHT.toFixed(2)} ‚Ç¨</span>
          </div>
        </div>
        
        <div style="background: #f4f8fb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">CONDITIONS D'EX√âCUTION :</b><br><br>
          
          <b>üìÖ Planning :</b><br>
          ‚Ä¢ D√©marrage : ${demarrageDevis}<br>
          ‚Ä¢ Dur√©e estim√©e : ${dureeEstimee}<br>
          ‚Ä¢ Livraison : selon planning convenu<br><br>
          
          <b>üí∞ Modalit√©s de paiement :</b><br>
          ${demanderAcompte ? `‚Ä¢ Acompte de ${pourcentageAcompte}% √† la commande (${montantAcompte.toFixed(2)} ‚Ç¨)<br>‚Ä¢ Solde ${100 - pourcentageAcompte}% √† la livraison (${solde.toFixed(2)} ‚Ç¨)<br>` : '‚Ä¢ Paiement int√©gral √† la livraison<br>'}
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire uniquement' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ${modePaiement === 'virement' ? `‚Ä¢ IBAN : ${iban || '[VOTRE IBAN]'}<br>‚Ä¢ BIC : ${bic || '[VOTRE BIC]'}<br>‚Ä¢ Banque : ${banque || '[NOM BANQUE]'}<br>` : ''}<br>
          
          <b>üéØ Livrables garantis :</b><br>
          ‚Ä¢ Documentation compl√®te des prestations<br>
          ‚Ä¢ Support et conseils inclus<br>
          ‚Ä¢ Garantie de satisfaction<br>
        </div>
        
        <div class="mentions">
          <b>MENTIONS L√âGALES :</b><br>
          ‚Ä¢ TVA non applicable, art. 293 B du CGI<br>
          ‚Ä¢ Devis valable ${validiteDevis || 30} jours √† compter de la date d'√©mission<br>
          ‚Ä¢ Prix fermes et d√©finitifs en euros<br>
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire uniquement' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ‚Ä¢ P√©nalit√©s de retard : 3 fois le taux de l'int√©r√™t l√©gal<br>
          ‚Ä¢ Indemnit√© forfaitaire de recouvrement : 40 ‚Ç¨<br>
          ‚Ä¢ En cas de litige, seuls les tribunaux fran√ßais sont comp√©tents
        </div>
        
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #155724;">‚úÖ ACCEPTATION DU DEVIS :</b><br><br>
          <b>Pour valider ce devis, veuillez :</b><br>
          ‚òê Signer et cacheter ci-dessous<br>
          ‚òê Retourner par email : ${emetteurEmail}<br>
          ${demanderAcompte ? `‚òê Verser l'acompte de ${pourcentageAcompte}% (${montantAcompte.toFixed(2)} ‚Ç¨) sous 8 jours<br>` : '‚òê Pr√©voir le paiement int√©gral √† la livraison<br>'}<br>
          
          <b>TOTAL ACCEPT√â :</b> _______ ‚Ç¨<br><br>
          
          Le ___/___/_____ √† ____________<br><br>
          
          <b>Signature et cachet :</b><br>
          <div style="border: 1px dashed #6c757d; height: 80px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #6c757d; font-style: italic;">
            Signature du client et cachet de l'entreprise
          </div>
          
          <b>Mention "Bon pour accord"</b><br>
          <i>Nom et qualit√© du signataire</i>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <b style="color: #1a7ee7;">Merci de votre confiance !</b><br>
          Questions ? Contactez-moi au ${emetteurTel}<br><br>
          <i style="font-size: 0.9rem; color: #666;">
            ${emetteurNom} - ${emetteurContact} - SIRET ${emetteurSiret || '[√Ä COMPL√âTER]'} - ${emetteurEmail}
          </i>
        </div>
      `;
    }
    
    function genererFactureEURL(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocialEurl = document.getElementById('capitalSocialEurl').value;
      const numTvaEurl = document.getElementById('numTvaEurl').value;
      const dateCreationEurl = document.getElementById('dateCreationEurl').value;
      const gerantEurl = document.getElementById('gerantEurl').value;
      const associeUniqueEurl = document.getElementById('associeUniqueEurl').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT √† partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            <b>EURL au capital de ${capitalSocialEurl || '[CAPITAL]'} ‚Ç¨</b><br><br>
            Si√®ge social : ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br><br>
            SIRET : ${emetteurSiret || '[SIRET EURL]'}<br>
            RCS ${emetteurVilleRcs || '[VILLE RCS]'} : ${emetteurRcs || '[N¬∞ RCS]'}<br>
            N¬∞ TVA : ${numTvaEurl || '[N¬∞ TVA INTRA]'}<br><br>
            G√©rant : ${gerantEurl || '[NOM G√âRANT]'}<br>
            Associ√© unique : ${associeUniqueEurl || '[NOM ASSOCI√â]'}<br><br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N¬∞ <b>${numFacture || '2025-001'}</b></div>
            <div class="facture-info">Date d'√©mission : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Date d'√©ch√©ance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
            <div class="facture-info">Date de prestation : <b>${datePrestation || periode || '[P√âRIODE]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>ADRESS√â √Ä :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT]<br>'}
          ${clientTva ? `N¬∞ TVA : ${clientTva}<br>` : 'N¬∞ TVA : [N¬∞ TVA CLIENT si applicable]<br>'}
        </div>
        <table class="facture-table">
          <tr>
            <th>Description des prestations</th>
            <th>P√©riode</th>
            <th>Qt√©</th>
            <th>Prix unit. HT</th>
            <th>Prix unit. TTC</th>
            <th>Total HT</th>
            <th>Total TTC</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='7' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix / 1.20; // Pour EURL, HT = TTC / 1.20
              const totalHT = prixHT * (p.qte || 1);
              const totalTTC = p.prix * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${p.prix.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalTTC.toFixed(2)} ‚Ç¨</td></tr>`;
            }).join('')}
        </table>
        <div style="margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          ‚Ä¢ EURL assujettie √† la TVA depuis le ${dateCreationEurl ? new Date(dateCreationEurl).toLocaleDateString('fr-FR') : '[DATE CR√âATION]'}<br>
          ‚Ä¢ R√©gime r√©el normal - D√©clarations mensuelles<br>
          ‚Ä¢ Taux de TVA applicable : 20% (services aux entreprises)<br>
          ‚Ä¢ TVA sur les d√©bits (facturation)
        </div>
        <div class="facture-total">
          Total HT : ${totalHT.toFixed(2)} ‚Ç¨<br>
          TVA 20% : ${tva.toFixed(2)} ‚Ç¨<br>
          <span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalTTC.toFixed(2)} ‚Ç¨</span>
        </div>
        <div class="facture-paiement-box">
          <b>MODALIT√âS DE PAIEMENT</b><br>
          √âch√©ance : 30 jours nets √† r√©ception<br>
          Mode : ${modePaiement === 'virement' ? 'Virement bancaire uniquement' : modePaiement === 'cheque' ? 'Ch√®que' : modePaiement === 'carte' ? 'Carte bancaire' : 'Esp√®ce'}<br>
          ${modePaiement === 'virement' ? `Devise : Euro (EUR)<br>Domiciliation bancaire : France<br><br><b>Coordonn√©es bancaires EURL :</b><br>IBAN : ${iban || '[IBAN EURL]'}<br>BIC : ${bic || '[BIC EURL]'}<br>Banque : ${banque || '[NOM BANQUE]'}<br>Titulaire : ${emetteurNom} EURL` : ''}
        </div>
        <div class="mentions">
          <b>MENTIONS L√âGALES OBLIGATOIRES EURL :</b><br>
          ‚Ä¢ En cas de retard de paiement : indemnit√© forfaitaire de recouvrement de 40 ‚Ç¨<br>
          ‚Ä¢ P√©nalit√©s de retard : 3 fois le taux de l'int√©r√™t l√©gal (soit 3,99% en 2025)<br>
          ‚Ä¢ Aucun escompte accord√© pour paiement anticip√©<br>
          ‚Ä¢ TVA sur les d√©bits - R√©gime r√©el normal<br>
          ‚Ä¢ Responsabilit√© limit√©e aux apports - EURL unipersonnelle<br>
          ‚Ä¢ G√©rance : ${gerantEurl || '[NOM G√âRANT]'} - Associ√© unique : ${associeUniqueEurl || '[NOM ASSOCI√â]'}
        </div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666;">
          <b>${emetteurNom} EURL</b><br>
          EURL au capital de ${capitalSocialEurl || '[CAPITAL]'} ‚Ç¨ - RCS ${emetteurVilleRcs || '[VILLE RCS]'} ${emetteurRcs || '[N¬∞ RCS]'} - SIRET ${emetteurSiret || '[SIRET]'} - N¬∞ TVA ${numTvaEurl || 'FR[N¬∞ TVA]'}<br>
          G√©rant : ${gerantEurl || '[NOM G√âRANT]'} - Associ√© unique : ${associeUniqueEurl || '[NOM ASSOCI√â]'}
        </div>
      `;
    }
    
    function genererDevisEURL(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocialEurl = document.getElementById('capitalSocialEurl').value;
      const numTvaEurl = document.getElementById('numTvaEurl').value;
      const dateCreationEurl = document.getElementById('dateCreationEurl').value;
      const gerantEurl = document.getElementById('gerantEurl').value;
      const associeUniqueEurl = document.getElementById('associeUniqueEurl').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT √† partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      let dateEcheance = '';
      if (dateFacture && validiteDevis) {
        const d = new Date(dateFacture);
        d.setDate(d.getDate() + parseInt(validiteDevis));
        dateEcheance = d.toLocaleDateString('fr-FR');
      }
      
      // Gestion de l'acompte
      const demanderAcompte = document.getElementById('demanderAcompte').checked;
      const pourcentageAcompte = parseInt(document.getElementById('pourcentageAcompte').value) || 40;
      const montantAcompte = demanderAcompte ? (totalTTC * pourcentageAcompte / 100) : 0;
      const solde = demanderAcompte ? (totalTTC - montantAcompte) : totalTTC;
      
      // Gestion du planning personnalis√©
      const demarrageDevis = document.getElementById('demarrageDevis').value || '2 semaines apr√®s signature';
      const dureeEstimee = document.getElementById('dureeEstimee').value || `${prestations.length > 0 ? Math.max(...prestations.map(p => p.qte || 1)) : 'X'} jour${prestations.length > 0 && Math.max(...prestations.map(p => p.qte || 1)) > 1 ? 's' : ''}`;
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.4rem;">${emetteurNom}</b><br>
            <b>EURL au capital de ${capitalSocialEurl || '[CAPITAL]'} ‚Ç¨</b><br><br>
            Si√®ge social : ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br><br>
            SIRET : ${emetteurSiret || '[SIRET EURL]'}<br>
            RCS ${emetteurVilleRcs || '[VILLE RCS]'} : ${emetteurRcs || '[N¬∞ RCS]'}<br>
            N¬∞ TVA : ${numTvaEurl || '[N¬∞ TVA INTRA]'}<br><br>
            G√©rant : ${gerantEurl || '[NOM G√âRANT]'}<br>
            Associ√© unique : ${associeUniqueEurl || '[NOM ASSOCI√â]'}<br><br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">DEVIS</div>
            <div class="facture-info">N¬∞ <b>${numFacture || 'D001'}</b></div>
            <div class="facture-info">Date : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Projet : <b>${periode || '[NOM PROJET]'}</b></div>
          </div>
        </div>
        
        <div class="facture-client-box">
          <b>CLIENT :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          <br>Contact : [NOM CONTACT]<br>
          Email : [EMAIL CLIENT]<br>
          T√©l : [T√âL√âPHONE CLIENT]<br>
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : ''}
          ${clientTva ? `N¬∞ TVA : ${clientTva}<br>` : ''}
        </div>
        
        <div style="background: #fff3cd; border: 2px solid #f0ad4e; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
          <b style="font-size: 1.1rem; color: #8a6d3b;">‚è∞ DEVIS VALABLE ${validiteDevis || 30} JOURS</b><br>
          √Ä partir du ${dateFacture || '[DATE]'} jusqu'au ${dateEcheance || '[DATE + ' + (validiteDevis || 30) + ' jours]'}
        </div>
        
        <div style="margin: 20px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">PRESTATIONS PROPOS√âES :</b>
        </div>
        
        <table class="facture-table">
          <tr>
            <th style="width: 40%;">Description d√©taill√©e</th>
            <th style="width: 12%;">Dur√©e estim√©e</th>
            <th style="width: 6%;">Qt√©</th>
            <th style="width: 14%;">Prix unit. HT</th>
            <th style="width: 14%;">Prix unit. TTC</th>
            <th style="width: 14%;">Total TTC</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='6' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix / 1.20; // Pour EURL, HT = TTC / 1.20
              const totalTTC = p.prix * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}<br><i style="color: #666;">Livrable : Document d√©taill√©</i></td><td style='text-align:center;'>${p.qte || 1} jour${(p.qte || 1) > 1 ? 's' : ''}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${p.prix.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalTTC.toFixed(2)} ‚Ç¨</td></tr>`;
            }).join('')}
        </table>
        
        <div style="margin: 20px 0; text-align: right;">
          <div style="display: inline-block; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1a7ee7;">
            <b>TOTAL HT :</b> ${totalHT.toFixed(2)} ‚Ç¨<br>
            <b>TVA 20% :</b> ${tva.toFixed(2)} ‚Ç¨<br><br>
            <span style="font-size: 1.3rem; font-weight: 800; color: #1a7ee7;">TOTAL TTC : ${totalTTC.toFixed(2)} ‚Ç¨</span>
          </div>
        </div>
        
        <div style="background: #f4f8fb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">CONDITIONS D'EX√âCUTION :</b><br><br>
          
          <b>üìÖ Planning :</b><br>
          ‚Ä¢ D√©marrage : ${demarrageDevis}<br>
          ‚Ä¢ Dur√©e estim√©e : ${dureeEstimee}<br>
          ‚Ä¢ Livraison : selon planning convenu<br><br>
          
          <b>üí∞ Modalit√©s de paiement :</b><br>
          ${demanderAcompte ? `‚Ä¢ Acompte de ${pourcentageAcompte}% √† la commande (${montantAcompte.toFixed(2)} ‚Ç¨ TTC)<br>‚Ä¢ Solde ${100 - pourcentageAcompte}% √† la livraison (${solde.toFixed(2)} ‚Ç¨ TTC)<br>` : '‚Ä¢ Paiement int√©gral √† la livraison<br>'}
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire uniquement' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ${modePaiement === 'virement' ? `‚Ä¢ IBAN : ${iban || '[IBAN EURL]'}<br>‚Ä¢ BIC : ${bic || '[BIC EURL]'}<br>‚Ä¢ Banque : ${banque || '[NOM BANQUE]'}<br>‚Ä¢ Titulaire : ${emetteurNom} EURL<br>` : ''}<br>
          
          <b>üéØ Livrables garantis :</b><br>
          ‚Ä¢ Documentation compl√®te des prestations<br>
          ‚Ä¢ Support et conseils inclus<br>
          ‚Ä¢ Garantie conforme aux obligations l√©gales EURL<br>
          ‚Ä¢ Clause de r√©serve de propri√©t√© jusqu'au paiement int√©gral<br>
        </div>
        
        <div style="background: #e8f4fd; border-radius: 8px; padding: 15px; margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          ‚Ä¢ EURL assujettie √† la TVA depuis le ${dateCreationEurl ? new Date(dateCreationEurl).toLocaleDateString('fr-FR') : '[DATE CR√âATION]'}<br>
          ‚Ä¢ R√©gime r√©el normal - D√©clarations mensuelles<br>
          ‚Ä¢ Taux de TVA applicable : 20% (services aux entreprises)<br>
          ‚Ä¢ TVA sur les d√©bits (facturation)
        </div>
        
        <div class="mentions">
          <b>MENTIONS L√âGALES :</b><br>
          ‚Ä¢ TVA 20% applicable - R√©gime r√©el normal<br>
          ‚Ä¢ Devis valable ${validiteDevis || 30} jours √† compter de la date d'√©mission<br>
          ‚Ä¢ Prix fermes et d√©finitifs en euros, TVA incluse<br>
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire exclusivement' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ‚Ä¢ P√©nalit√©s de retard : 3 fois le taux de l'int√©r√™t l√©gal<br>
          ‚Ä¢ Indemnit√© forfaitaire de recouvrement : 40 ‚Ç¨<br>
          ‚Ä¢ R√®glement des litiges : m√©diation prioritaire, juridiction fran√ßaise
        </div>
        
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #155724;">‚úÖ ACCEPTATION DU DEVIS :</b><br><br>
          <b>Pour valider ce devis, veuillez :</b><br>
          ‚òê Signer et cacheter ci-dessous<br>
          ‚òê Retourner par email : ${emetteurEmail}<br>
          ${demanderAcompte ? `‚òê Verser l'acompte de ${pourcentageAcompte}% (${montantAcompte.toFixed(2)} ‚Ç¨ TTC) sous 8 jours<br>` : '‚òê Pr√©voir le paiement int√©gral √† la livraison<br>'}<br>
          
          <b>TOTAL ACCEPT√â TTC :</b> _______ ‚Ç¨<br><br>
          
          Le ___/___/_____ √† ____________<br><br>
          
          <b>Signature et cachet :</b><br>
          <div style="border: 1px dashed #6c757d; height: 80px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #6c757d; font-style: italic;">
            Signature du client et cachet de l'entreprise
          </div>
          
          <b>Mention "Bon pour accord"</b><br>
          <i>Nom et qualit√© du signataire</i>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <b style="color: #1a7ee7;">Merci de votre confiance !</b><br>
          Questions ? Contactez-moi au ${emetteurTel}<br><br>
          <i style="font-size: 0.9rem; color: #666;">
            ${emetteurNom} EURL - Capital ${capitalSocialEurl || '[CAPITAL]'} ‚Ç¨ - RCS ${emetteurVilleRcs || '[VILLE RCS]'} ${emetteurRcs || '[N¬∞ RCS]'}<br>
            SIRET ${emetteurSiret || '[SIRET]'} - N¬∞ TVA ${numTvaEurl || 'FR[N¬∞ TVA]'} - ${emetteurEmail}
          </i>
        </div>
      `;
    }
    
    function genererFactureSASU(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocial = document.getElementById('capitalSocial').value;
      const numTva = document.getElementById('numTva').value;
      const dateCreationSasu = document.getElementById('dateCreationSasu').value;
      const presidentSasu = document.getElementById('presidentSasu').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT √† partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            <b>SASU au capital de ${capitalSocial || '[CAPITAL]'} ‚Ç¨</b><br><br>
            Pr√©sident : ${presidentSasu || '[PR√âNOM NOM]'}<br><br>
            Si√®ge social : ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br><br>
            SIRET : ${emetteurSiret || '[SIRET SASU]'}<br>
            RCS ${emetteurVilleRcs || '[VILLE RCS]'} : ${emetteurRcs || '[N¬∞ RCS]'}<br>
            N¬∞ TVA : ${numTva || '[N¬∞ TVA INTRA]'}<br><br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N¬∞ <b>${numFacture || '2025-001'}</b></div>
            <div class="facture-info">Date d'√©mission : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Date d'√©ch√©ance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
            <div class="facture-info">Date de prestation : <b>${datePrestation || periode || '[P√âRIODE]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>ADRESS√â √Ä :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT]<br>'}
          ${clientTva ? `N¬∞ TVA : ${clientTva}<br>` : 'N¬∞ TVA : [N¬∞ TVA CLIENT si applicable]<br>'}
        </div>
                 <table class="facture-table">
           <tr>
             <th>Description des prestations</th>
             <th>P√©riode</th>
             <th>Qt√©</th>
             <th>Prix unit. HT</th>
             <th>Prix unit. TTC</th>
             <th>Total HT</th>
             <th>Total TTC</th>
           </tr>
           ${prestations.length === 0 ? `<tr><td colspan='7' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
             prestations.map(p => {
               const prixHT = p.prix / 1.20; // Pour SASU, HT = TTC / 1.20
               const totalHT = prixHT * (p.qte || 1);
               const totalTTC = p.prix * (p.qte || 1);
               return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${p.prix.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalTTC.toFixed(2)} ‚Ç¨</td></tr>`;
             }).join('')}
         </table>
        <div style="margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          ‚Ä¢ Assujetti √† la TVA depuis le ${dateCreationSasu ? new Date(dateCreationSasu).toLocaleDateString('fr-FR') : '[DATE CR√âATION SASU]'}<br>
          ‚Ä¢ Taux de TVA applicable : 20%<br>
          ‚Ä¢ Facturation avec TVA obligatoire
        </div>
                 <div class="facture-total">
           Total HT : ${totalHT.toFixed(2)} ‚Ç¨<br>
           TVA 20% : ${tva.toFixed(2)} ‚Ç¨<br>
           <span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalTTC.toFixed(2)} ‚Ç¨</span>
         </div>
        <div class="facture-paiement-box">
          <b>MODALIT√âS DE PAIEMENT</b><br>
          √âch√©ance : 30 jours nets<br>
          Mode : ${modePaiement === 'virement' ? 'Virement bancaire' : modePaiement === 'cheque' ? 'Ch√®que' : modePaiement === 'carte' ? 'Carte bancaire' : 'Esp√®ce'}<br>
          ${modePaiement === 'virement' ? `Devise : Euro (EUR)<br><br><b>Coordonn√©es bancaires :</b><br>IBAN : ${iban || '[IBAN SASU]'}<br>BIC : ${bic || '[BIC SASU]'}<br>Banque : ${banque || '[NOM BANQUE]'}` : ''}
        </div>
        <div class="mentions">
          <b>MENTIONS L√âGALES OBLIGATOIRES :</b><br>
          ‚Ä¢ En cas de retard de paiement, indemnit√© forfaitaire de recouvrement : 40 ‚Ç¨<br>
          ‚Ä¢ Taux de p√©nalit√© de retard : 3 fois le taux de l'int√©r√™t l√©gal (soit 3,99% en 2025)<br>
          ‚Ä¢ Aucun escompte accord√© pour paiement anticip√©<br>
          ‚Ä¢ TVA sur les d√©bits (encaissement)
        </div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666;">
          <b>${emetteurNom} SASU</b><br>
          SASU au capital de ${capitalSocial || '[CAPITAL]'} ‚Ç¨ - RCS ${emetteurVilleRcs || '[VILLE RCS]'} ${emetteurRcs || '[N¬∞ RCS]'} - SIRET ${emetteurSiret || '[SIRET]'} - N¬∞ TVA ${numTva || 'FR[N¬∞ TVA]'}<br>
          Pr√©sident : ${presidentSasu || '[PR√âNOM NOM]'}
        </div>
      `;
    }
    
    function genererDevisSASU(numFacture, dateFacture, validiteDevis, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, modePaiement, emetteurNom, emetteurContact, emetteurAdresse, emetteurCodePostal, emetteurVille, emetteurSiret, emetteurRcs, emetteurVilleRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocial = document.getElementById('capitalSocial').value;
      const numTva = document.getElementById('numTva').value;
      const dateCreationSasu = document.getElementById('dateCreationSasu').value;
      const presidentSasu = document.getElementById('presidentSasu').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT √† partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      let dateEcheance = '';
      if (dateFacture && validiteDevis) {
        const d = new Date(dateFacture);
        d.setDate(d.getDate() + parseInt(validiteDevis));
        dateEcheance = d.toLocaleDateString('fr-FR');
      }
      
      // Gestion de l'acompte
      const demanderAcompte = document.getElementById('demanderAcompte').checked;
      const pourcentageAcompte = parseInt(document.getElementById('pourcentageAcompte').value) || 40;
      const montantAcompte = demanderAcompte ? (totalTTC * pourcentageAcompte / 100) : 0;
      const solde = demanderAcompte ? (totalTTC - montantAcompte) : totalTTC;
      
      // Gestion du planning personnalis√©
      const demarrageDevis = document.getElementById('demarrageDevis').value || '2 semaines apr√®s signature';
      const dureeEstimee = document.getElementById('dureeEstimee').value || `${prestations.length > 0 ? Math.max(...prestations.map(p => p.qte || 1)) : 'X'} jour${prestations.length > 0 && Math.max(...prestations.map(p => p.qte || 1)) > 1 ? 's' : ''}`;
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            ${logoEntrepriseData ? `<img src="${logoEntrepriseData}" style="max-width: 120px; max-height: 80px; margin-bottom: 10px; display: block;"><br>` : ''}
            <b style="font-size:1.4rem;">${emetteurNom}</b><br>
            <b>SASU au capital de ${capitalSocial || '[CAPITAL]'} ‚Ç¨</b><br><br>
            Pr√©sident : ${presidentSasu || '[PR√âNOM NOM]'}<br><br>
            Si√®ge social : ${emetteurAdresse}<br>
            ${emetteurCodePostal} ${emetteurVille}<br><br>
            SIRET : ${emetteurSiret || '[SIRET SASU]'}<br>
            RCS ${emetteurVilleRcs || '[VILLE RCS]'} : ${emetteurRcs || '[N¬∞ RCS]'}<br>
            N¬∞ TVA : ${numTva || '[N¬∞ TVA INTRA]'}<br><br>
            Email : ${emetteurEmail}<br>
            T√©l : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">DEVIS</div>
            <div class="facture-info">N¬∞ <b>${numFacture || 'D001'}</b></div>
            <div class="facture-info">Date : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Projet : <b>${periode || '[NOM PROJET]'}</b></div>
          </div>
        </div>
        
        <div class="facture-client-box">
          <b>CLIENT :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          <br>Contact : [NOM CONTACT]<br>
          Email : [EMAIL CLIENT]<br>
          T√©l : [T√âL√âPHONE CLIENT]<br>
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : ''}
          ${clientTva ? `N¬∞ TVA : ${clientTva}<br>` : ''}
        </div>
        
        <div style="background: #fff3cd; border: 2px solid #f0ad4e; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
          <b style="font-size: 1.1rem; color: #8a6d3b;">‚è∞ DEVIS VALABLE ${validiteDevis || 30} JOURS</b><br>
          √Ä partir du ${dateFacture || '[DATE]'} jusqu'au ${dateEcheance || '[DATE + ' + (validiteDevis || 30) + ' jours]'}
        </div>
        
        <div style="margin: 20px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">PRESTATIONS PROPOS√âES :</b>
        </div>
        
        <table class="facture-table">
          <tr>
            <th style="width: 40%;">Description d√©taill√©e</th>
            <th style="width: 12%;">Dur√©e estim√©e</th>
            <th style="width: 6%;">Qt√©</th>
            <th style="width: 14%;">Prix unit. HT</th>
            <th style="width: 14%;">Prix unit. TTC</th>
            <th style="width: 14%;">Total TTC</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='6' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix / 1.20; // Pour SASU, HT = TTC / 1.20
              const totalTTC = p.prix * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}<br><i style="color: #666;">Livrable : Document d√©taill√©</i></td><td style='text-align:center;'>${p.qte || 1} jour${(p.qte || 1) > 1 ? 's' : ''}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${p.prix.toFixed(2)} ‚Ç¨</td><td style='text-align:right;'>${totalTTC.toFixed(2)} ‚Ç¨</td></tr>`;
            }).join('')}
        </table>
        
        <div style="margin: 20px 0; text-align: right;">
          <div style="display: inline-block; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1a7ee7;">
            <b>TOTAL HT :</b> ${totalHT.toFixed(2)} ‚Ç¨<br>
            <b>TVA 20% :</b> ${tva.toFixed(2)} ‚Ç¨<br><br>
            <span style="font-size: 1.3rem; font-weight: 800; color: #1a7ee7;">TOTAL TTC : ${totalTTC.toFixed(2)} ‚Ç¨</span>
          </div>
        </div>
        
        <div style="background: #f4f8fb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #1a7ee7;">CONDITIONS D'EX√âCUTION :</b><br><br>
          
          <b>üìÖ Planning :</b><br>
          ‚Ä¢ D√©marrage : ${demarrageDevis}<br>
          ‚Ä¢ Dur√©e estim√©e : ${dureeEstimee}<br>
          ‚Ä¢ Livraison : selon planning convenu<br><br>
          
          <b>üí∞ Modalit√©s de paiement :</b><br>
          ${demanderAcompte ? `‚Ä¢ Acompte de ${pourcentageAcompte}% √† la commande (${montantAcompte.toFixed(2)} ‚Ç¨ TTC)<br>‚Ä¢ Solde ${100 - pourcentageAcompte}% √† la livraison (${solde.toFixed(2)} ‚Ç¨ TTC)<br>` : '‚Ä¢ Paiement int√©gral √† la livraison<br>'}
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ${modePaiement === 'virement' ? `‚Ä¢ IBAN : ${iban || '[IBAN SASU]'}<br>‚Ä¢ BIC : ${bic || '[BIC SASU]'}<br>‚Ä¢ Banque : ${banque || '[NOM BANQUE]'}<br>` : ''}<br>
          
          <b>üéØ Livrables garantis :</b><br>
          ‚Ä¢ Documentation compl√®te des prestations<br>
          ‚Ä¢ Support et conseils inclus<br>
          ‚Ä¢ Garantie conforme aux obligations l√©gales SASU<br>
          ‚Ä¢ Clause de r√©serve de propri√©t√© jusqu'au paiement int√©gral<br>
        </div>
        
        <div style="background: #e8f4fd; border-radius: 8px; padding: 15px; margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          ‚Ä¢ Assujetti √† la TVA depuis le ${dateCreationSasu ? new Date(dateCreationSasu).toLocaleDateString('fr-FR') : '[DATE CR√âATION SASU]'}<br>
          ‚Ä¢ Taux de TVA applicable : 20%<br>
          ‚Ä¢ Facturation avec TVA obligatoire
        </div>
        
        <div class="mentions">
          <b>MENTIONS L√âGALES :</b><br>
          ‚Ä¢ TVA 20% applicable - Facturation obligatoire<br>
          ‚Ä¢ Devis valable ${validiteDevis || 30} jours √† compter de la date d'√©mission<br>
          ‚Ä¢ Prix fermes et d√©finitifs en euros, TVA incluse<br>
          ‚Ä¢ R√®glement par ${modePaiement === 'virement' ? 'virement bancaire' : modePaiement === 'cheque' ? 'ch√®que' : modePaiement === 'carte' ? 'carte bancaire' : 'esp√®ce'}<br>
          ‚Ä¢ P√©nalit√©s de retard : 3 fois le taux de l'int√©r√™t l√©gal<br>
          ‚Ä¢ Indemnit√© forfaitaire de recouvrement : 40 ‚Ç¨<br>
          ‚Ä¢ R√®glement des litiges : m√©diation prioritaire, juridiction fran√ßaise
        </div>
        
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 25px 0;">
          <b style="font-size: 1.1rem; color: #155724;">‚úÖ ACCEPTATION DU DEVIS :</b><br><br>
          <b>Pour valider ce devis, veuillez :</b><br>
          ‚òê Signer et cacheter ci-dessous<br>
          ‚òê Retourner par email : ${emetteurEmail}<br>
          ${demanderAcompte ? `‚òê Verser l'acompte de ${pourcentageAcompte}% (${montantAcompte.toFixed(2)} ‚Ç¨ TTC) sous 8 jours<br>` : '‚òê Pr√©voir le paiement int√©gral √† la livraison<br>'}<br>
          
          <b>TOTAL ACCEPT√â TTC :</b> _______ ‚Ç¨<br><br>
          
          Le ___/___/_____ √† ____________<br><br>
          
          <b>Signature et cachet :</b><br>
          <div style="border: 1px dashed #6c757d; height: 80px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #6c757d; font-style: italic;">
            Signature du client et cachet de l'entreprise
          </div>
          
          <b>Mention "Bon pour accord"</b><br>
          <i>Nom et qualit√© du signataire</i>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <b style="color: #1a7ee7;">Merci de votre confiance !</b><br>
          Questions ? Contactez-moi au ${emetteurTel}<br><br>
          <i style="font-size: 0.9rem; color: #666;">
            ${emetteurNom} SASU - Capital ${capitalSocial || '[CAPITAL]'} ‚Ç¨ - RCS ${emetteurVilleRcs || '[VILLE RCS]'} ${emetteurRcs || '[N¬∞ RCS]'}<br>
            SIRET ${emetteurSiret || '[SIRET]'} - N¬∞ TVA ${numTva || 'FR[N¬∞ TVA]'} - Pr√©sident : ${presidentSasu || '[PR√âNOM NOM]'} - ${emetteurEmail}
          </i>
        </div>
      `;
    }
    
    document.querySelectorAll('#factureForm input, #factureForm select').forEach(input => {
      input.addEventListener('input', majApercu);
    });
    
    // Ajouter l'√©couteur pour le champ de validit√© du devis
    document.getElementById('validiteDevis').addEventListener('input', majApercu);
    
    // Ajouter l'√©couteur pour le champ d'acompte
    document.getElementById('pourcentageAcompte').addEventListener('input', majApercu);
    
    // Ajouter les √©couteurs pour les champs de planning personnalis√©
    document.getElementById('demarrageDevis').addEventListener('input', majApercu);
    document.getElementById('dureeEstimee').addEventListener('input', majApercu);
    function imprimerDocument() {
      majApercu();
      const element = document.getElementById('factureApercu');
      if (!element || !element.innerHTML.trim()) {
        alert("Aper√ßu vide !");
        return;
      }
      // Afficher la taille de l'√©l√©ment pour debug
      console.log('Taille aper√ßu:', element.offsetWidth, element.offsetHeight);
      // Capturer l'aper√ßu en image
      html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        // Format A4 : 210 x 297 mm
        const pdf = new jspdf.jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 10; // marges de 10mm
        const usableWidth = pageWidth - (margin * 2);
        const usableHeight = pageHeight - (margin * 2);
        
        // Calculer la largeur optimale de l'image
        const imgWidth = usableWidth;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        // Si l'image tient dans une page
        if (imgHeight <= usableHeight) {
          const x = (pageWidth - imgWidth) / 2;
          const y = margin;
          pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        } else {
          // Si l'image d√©passe une page, la diviser en plusieurs pages
          const ratio = canvas.width / canvas.height;
          const pageImgHeight = usableHeight;
          const pageImgWidth = pageImgHeight * ratio;
          
          // Calculer le nombre de pages n√©cessaires
          const totalPages = Math.ceil(imgHeight / usableHeight);
          
          console.log(`Document trop grand, division en ${totalPages} pages`);
          
          // Cr√©er un canvas temporaire pour chaque page
          for (let pageNum = 0; pageNum < totalPages; pageNum++) {
            const startY = pageNum * usableHeight * (canvas.height / imgHeight);
            const sliceHeight = Math.min(usableHeight * (canvas.height / imgHeight), canvas.height - startY);
            
            // Cr√©er un canvas pour cette portion
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = sliceHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Copier la portion de l'image originale
            tempCtx.drawImage(canvas, 0, startY, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
            
            // Ajouter une nouvelle page si ce n'est pas la premi√®re
            if (pageNum > 0) {
              pdf.addPage();
            }
            
            // Calculer les dimensions pour cette page
            const pageImgData = tempCanvas.toDataURL('image/jpeg', 1.0);
            const actualHeight = sliceHeight * imgWidth / canvas.width;
            const x = (pageWidth - imgWidth) / 2;
            const y = margin;
            
            pdf.addImage(pageImgData, 'JPEG', x, y, imgWidth, actualHeight);
            
            // Ajouter un num√©ro de page en bas de chaque page
            pdf.setFontSize(8);
            pdf.setTextColor(128, 128, 128);
            pdf.text(`Page ${pageNum + 1}/${totalPages}`, pageWidth - 20, pageHeight - 5);
          }
        }
        
        const numFacture = document.getElementById('numFacture').value || (isFactureMode ? 'F001' : 'D001');
        const clientNom = document.getElementById('clientNom').value || 'CLIENT';
        // Nettoyer le nom du client pour le nom de fichier (supprimer espaces et caract√®res sp√©ciaux)
        const clientNomClean = clientNom.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        const docType = isFactureMode ? 'FACTURE' : 'DEVIS';
        const filename = `${docType}_${numFacture}_${clientNomClean}.pdf`;
        pdf.save(filename);
      }).catch(err => {
        console.error('Erreur lors de la g√©n√©ration du PDF:', err);
        alert('Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.');
      });
    }
    
    function exporterCSV() {
      const statutJuridique = document.getElementById('statutJuridique').value;
      const numFacture = document.getElementById('numFacture').value || (isFactureMode ? 'F001' : 'D001');
      const dateFacture = document.getElementById('dateFacture').value || '';
      const clientNom = document.getElementById('clientNom').value || '';
      const clientAdresse = document.getElementById('clientAdresse').value || '';
      const clientVille = document.getElementById('clientVille').value || '';
      const clientSiret = document.getElementById('clientSiret').value || '';
      const periode = document.getElementById('periode').value || '';
      const emetteurNom = document.getElementById('emetteurNom').value || '';
      const emetteurContact = document.getElementById('emetteurContact').value || '';
      const emetteurAdresse = document.getElementById('emetteurAdresse').value || '';
      const emetteurCodePostal = document.getElementById('emetteurCodePostal').value || '';
      const emetteurVille = document.getElementById('emetteurVille').value || '';
      const emetteurSiret = document.getElementById('emetteurSiret').value || '';
      const emetteurEmail = document.getElementById('emetteurEmail').value || '';
      const emetteurTel = document.getElementById('emetteurTel').value || '';
      const iban = document.getElementById('iban').value || '';
      const bic = document.getElementById('bic').value || '';
      const banque = document.getElementById('banque').value || '';
      const modePaiement = document.getElementById('modePaiement').value || '';
      const validiteDevis = document.getElementById('validiteDevis').value || '';
      
      // Calculer les totaux
      const totalPrix = prestations.reduce((acc, p) => acc + (p.prix * (p.qte || 1)), 0);
      let totalHT, totalTTC, totalTVA;
      
      if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
        totalTTC = totalPrix;
        totalHT = totalTTC / 1.20;
        totalTVA = totalTTC - totalHT;
      } else {
        totalHT = totalPrix;
        totalTTC = totalPrix; // Pour micro-entreprise, TTC = HT
        totalTVA = 0;
      }
      
      // Cr√©er le contenu CSV avec BOM UTF-8 pour les caract√®res accentu√©s fran√ßais
      let csvContent = '\uFEFF'; // BOM UTF-8 pour Excel
      
      // En-t√™te avec informations g√©n√©rales
      const docType = isFactureMode ? 'FACTURE' : 'DEVIS';
      csvContent += `INFORMATIONS ${docType}\n`;
      csvContent += 'Type,Valeur\n';
      csvContent += `Num√©ro de ${docType.toLowerCase()},${numFacture}\n`;
      csvContent += `Date de ${docType.toLowerCase()},${dateFacture}\n`;
      csvContent += `Statut juridique,${statutJuridique.toUpperCase()}\n`;
      csvContent += `P√©riode ${isFactureMode ? 'factur√©e' : 'pr√©vue'},${periode}\n`;
      if (!isFactureMode) {
        csvContent += `Validit√© du devis,${validiteDevis} jours\n`;
      }
      csvContent += '\n';
      
      // Informations √©metteur
      csvContent += 'INFORMATIONS √âMETTEUR\n';
      csvContent += 'Type,Valeur\n';
      csvContent += `Nom entreprise,${emetteurNom}\n`;
      csvContent += `Contact,${emetteurContact}\n`;
      csvContent += `Adresse,${emetteurAdresse}\n`;
      csvContent += `Code postal,${emetteurCodePostal}\n`;
      csvContent += `Ville,${emetteurVille}\n`;
      csvContent += `SIRET,${emetteurSiret}\n`;
      csvContent += `Email,${emetteurEmail}\n`;
      csvContent += `T√©l√©phone,${emetteurTel}\n`;
      csvContent += '\n';
      
      // Informations client
      csvContent += 'INFORMATIONS CLIENT\n';
      csvContent += 'Type,Valeur\n';
      csvContent += `Nom client,${clientNom}\n`;
      csvContent += `Adresse client,${clientAdresse}\n`;
      csvContent += `Ville client,${clientVille}\n`;
      csvContent += `SIRET client,${clientSiret}\n`;
      csvContent += '\n';
      
      // Prestations
      csvContent += 'PRESTATIONS\n';
      if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
        csvContent += 'Titre,Description,Quantit√©,Prix unitaire HT,Prix unitaire TTC,Total HT,Total TTC\n';
      } else {
        csvContent += 'Titre,Description,Quantit√©,Prix unitaire HT,Total HT\n';
      }
      
      prestations.forEach(p => {
        const titre = `"${p.titre.replace(/"/g, '""')}"`;
        const desc = `"${p.desc.replace(/"/g, '""')}"`;
        const qte = p.qte || 1;
        
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          const prixHT = p.prix / 1.20;
          const prixTTC = p.prix;
          const totalHT = prixHT * qte;
          const totalTTC = prixTTC * qte;
          csvContent += `${titre},${desc},${qte},${prixHT.toFixed(2)},${prixTTC.toFixed(2)},${totalHT.toFixed(2)},${totalTTC.toFixed(2)}\n`;
        } else {
          const prixHT = p.prix;
          const totalHT = prixHT * qte;
          csvContent += `${titre},${desc},${qte},${prixHT.toFixed(2)},${totalHT.toFixed(2)}\n`;
        }
      });
      
      csvContent += '\n';
      
      // Totaux
      csvContent += 'TOTAUX\n';
      csvContent += 'Type,Montant\n';
      csvContent += `Total HT,${totalHT.toFixed(2)}\n`;
      if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
        csvContent += `TVA 20%,${totalTVA.toFixed(2)}\n`;
      } else {
        csvContent += `TVA,Non applicable\n`;
      }
      csvContent += `Total TTC,${totalTTC.toFixed(2)}\n`;
      csvContent += '\n';
      
      // Informations bancaires
      csvContent += 'INFORMATIONS BANCAIRES\n';
      csvContent += 'Type,Valeur\n';
      csvContent += `Mode de paiement,${modePaiement}\n`;
      csvContent += `IBAN,${iban}\n`;
      csvContent += `BIC,${bic}\n`;
      csvContent += `Banque,${banque}\n`;
      
      // Cr√©er et t√©l√©charger le fichier CSV avec encodage UTF-8 explicite
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        
        const clientNomClean = clientNom.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        const docType = isFactureMode ? 'FACTURE' : 'DEVIS';
        const filename = `${docType}_${numFacture}_${clientNomClean}.csv`;
        link.setAttribute('download', filename);
        
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('Fichier CSV export√©:', filename);
      } else {
        alert('Votre navigateur ne supporte pas le t√©l√©chargement de fichiers CSV.');
      }
    }
    
    // Fonctionnalit√© de scroll synchronis√©
    function initScrollSynchronise() {
      // Mapping des sections du formulaire vers les sections de l'aper√ßu
      const sectionMapping = {
        'emetteurNom': '.facture-emetteur',
        'emetteurContact': '.facture-emetteur',
        'emetteurAdresse': '.facture-emetteur',
        'emetteurCodePostal': '.facture-emetteur',
        'emetteurVille': '.facture-emetteur',
        'emetteurSiret': '.facture-emetteur',
        'emetteurRcs': '.facture-emetteur',
        'emetteurVilleRcs': '.facture-emetteur',
        'emetteurEmail': '.facture-emetteur',
        'emetteurTel': '.facture-emetteur',
        'numFacture': '.facture-title',
        'dateFacture': '.facture-info',
        'clientNom': '.facture-client-box',
        'clientAdresse': '.facture-client-box',
        'clientVille': '.facture-client-box',
        'clientSiret': '.facture-client-box',
        'periode': '.facture-table',
        'titrePresta': '.facture-table',
        'descPresta': '.facture-table',
        'prixHT': '.facture-table',
        'prixPresta': '.facture-table',
        'qtePresta': '.facture-table',
        'modePaiement': '.facture-paiement-box',
        'iban': '.facture-paiement-box',
        'bic': '.facture-paiement-box',
        'banque': '.facture-paiement-box'
      };
      
      // Ajouter des √©couteurs d'√©v√©nements focus sur tous les champs
      Object.keys(sectionMapping).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('focus', () => {
            scrollToPreviewSection(sectionMapping[fieldId]);
          });
        }
      });
      
      // Scroll automatique lors du clic sur les boutons d'ajout de prestation
      const addPrestationBtn = document.querySelector('button[onclick="ajouterPrestation()"]');
      if (addPrestationBtn) {
        addPrestationBtn.addEventListener('click', () => {
          setTimeout(() => {
            scrollToPreviewSection('.facture-table');
          }, 300);
        });
      }
    }
    
    function scrollToPreviewSection(selector) {
      const factureSection = document.querySelector('.facture-section');
      const targetElement = document.querySelector(selector);
      const syncIndicator = document.getElementById('syncIndicator');
      
      if (factureSection && targetElement) {
        // V√©rifier si on est sur mobile (moins de 900px)
        const isMobile = window.innerWidth <= 900;
        
        if (isMobile) {
          // Sur mobile, juste faire un highlight sans scroll
          highlightActiveSection(selector);
          return;
        }
        
        // Afficher l'indicateur de synchronisation
        if (syncIndicator) {
          syncIndicator.classList.add('show');
          setTimeout(() => {
            syncIndicator.classList.remove('show');
          }, 2000);
        }
        
        const factureRect = factureSection.getBoundingClientRect();
        const targetRect = targetElement.getBoundingClientRect();
        
        // Calculer la position relative dans l'aper√ßu
        const relativeTop = targetRect.top - factureRect.top;
        const scrollTop = factureSection.scrollTop + relativeTop - 50; // 50px de marge
        
        // Scroll fluide vers la section cible
        factureSection.scrollTo({
          top: Math.max(0, scrollTop),
          behavior: 'smooth'
        });
        
        // Ajouter un highlight visuel apr√®s un court d√©lai
        setTimeout(() => {
          highlightActiveSection(selector);
        }, 200);
      }
    }
    
    // Am√©liorer l'exp√©rience avec un indicateur visuel
    function highlightActiveSection(selector) {
      // Supprimer les anciens highlights
      document.querySelectorAll('.section-highlight').forEach(el => {
        el.classList.remove('section-highlight');
      });
      
      // Ajouter le highlight √† la section active
      const targetElement = document.querySelector(selector);
      if (targetElement) {
        targetElement.classList.add('section-highlight');
        setTimeout(() => {
          targetElement.classList.remove('section-highlight');
        }, 2000);
      }
    }
    
    // Initialisation
    function initialiserFormulaire() {
      const aujourdhui = new Date().toISOString().split('T')[0];
      document.getElementById('dateFacture').value = aujourdhui;
      document.getElementById('datePrestation').value = aujourdhui;
      
      // Ajouter l'√©couteur d'√©v√©nement pour le toggle
      document.getElementById('modeToggle').addEventListener('change', toggleMode);
      
      // Charger les valeurs de configuration si disponibles
      if (typeof CONFIG !== 'undefined') {
        document.getElementById('emetteurNom').value = CONFIG.emetteurNom || '';
        document.getElementById('emetteurContact').value = CONFIG.emetteurContact || '';
        document.getElementById('emetteurAdresse').value = CONFIG.emetteurAdresse || '';
        document.getElementById('emetteurCodePostal').value = CONFIG.emetteurCodePostal || '';
        document.getElementById('emetteurVille').value = CONFIG.emetteurVille || '';
        document.getElementById('emetteurSiret').value = CONFIG.emetteurSiret || '';
        document.getElementById('emetteurRcs').value = CONFIG.emetteurRcs || '';
        document.getElementById('emetteurVilleRcs').value = CONFIG.emetteurVilleRcs || '';
        document.getElementById('emetteurEmail').value = CONFIG.emetteurEmail || '';
        document.getElementById('emetteurTel').value = CONFIG.emetteurTel || '';
        document.getElementById('iban').value = CONFIG.iban || '';
        document.getElementById('bic').value = CONFIG.bic || '';
        document.getElementById('banque').value = CONFIG.banque || '';
        
        // Valeurs sp√©cifiques SASU
        if (CONFIG.capitalSocial) document.getElementById('capitalSocial').value = CONFIG.capitalSocial;
        if (CONFIG.numTva) document.getElementById('numTva').value = CONFIG.numTva;
        if (CONFIG.dateCreationSasu) document.getElementById('dateCreationSasu').value = CONFIG.dateCreationSasu;
        if (CONFIG.presidentSasu) document.getElementById('presidentSasu').value = CONFIG.presidentSasu;
        
        // Valeurs sp√©cifiques EURL
        if (CONFIG.capitalSocialEurl) document.getElementById('capitalSocialEurl').value = CONFIG.capitalSocialEurl;
        if (CONFIG.numTvaEurl) document.getElementById('numTvaEurl').value = CONFIG.numTvaEurl;
        if (CONFIG.dateCreationEurl) document.getElementById('dateCreationEurl').value = CONFIG.dateCreationEurl;
        if (CONFIG.gerantEurl) document.getElementById('gerantEurl').value = CONFIG.gerantEurl;
        if (CONFIG.associeUniqueEurl) document.getElementById('associeUniqueEurl').value = CONFIG.associeUniqueEurl;
        
        if (CONFIG.statutJuridique) document.getElementById('statutJuridique').value = CONFIG.statutJuridique;
        
        // Chargement du logo par d√©faut s'il est d√©fini
        if (CONFIG.logoEntreprise) {
          logoEntrepriseData = CONFIG.logoEntreprise;
          document.getElementById('logoImage').src = logoEntrepriseData;
          document.getElementById('logoPreview').style.display = 'block';
        }
        
        // Configuration sp√©cifique micro-entreprise RCS
        if (CONFIG.microAUnRcs !== undefined) {
          document.getElementById('microAUnRcs').checked = CONFIG.microAUnRcs;
        }
      }
      
      // Initialiser l'affichage des champs selon le statut
      changerStatut();
      majApercu();
      
      // Initialiser le scroll synchronis√©
      initScrollSynchronise();
    }
    initialiserFormulaire();
  </script>
  
  <div style="text-align: center; margin-top: 30px; padding: 20px; font-size: 0.9rem; color: #666; background: #f8f9fa; border-top: 1px solid #e9ecef;">
    Made with ‚ù§Ô∏è by AllieEco
  </div>
</body>
</html> 