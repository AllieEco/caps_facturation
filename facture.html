<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Facture - CAPSLOCK</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><style>.cls-1{fill:%23f4d03f;}.cls-2{fill:%23333;stroke:%23333;stroke-width:2;fill:none;}.cls-3{fill:%23333;}</style></defs><polygon class='cls-1' points='45,10 50,20 60,20 52,28 55,38 45,33 35,38 38,28 30,20 40,20'/><polygon class='cls-1' points='70,25 73,30 78,30 75,33 76,38 70,35 64,38 65,33 62,30 67,30'/><polygon class='cls-1' points='58,45 61,50 66,50 63,53 64,58 58,55 52,58 53,53 50,50 55,50'/><rect class='cls-2' x='15' y='25' width='45' height='60' rx='3'/><rect class='cls-3' x='20' y='35' width='25' height='2'/><rect class='cls-3' x='20' y='45' width='20' height='2'/><rect class='cls-3' x='20' y='55' width='25' height='2'/><rect class='cls-3' x='20' y='65' width='15' height='2'/><circle class='cls-2' cx='70' cy='60' r='15'/><text x='70' y='67' text-anchor='middle' class='cls-3' font-family='Arial' font-size='16' font-weight='bold'>$</text><path class='cls-2' d='M15,80 Q15,85 20,85 L75,85 Q80,85 80,80 L80,75 L15,75 Z'/></svg>" type="image/svg+xml">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; background: #f7fafd; margin: 0; padding: 0; color: #222; }
    .container { max-width: 1100px; margin: 30px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); padding: 32px 24px; display: flex; gap: 40px; }
    .form-section { flex: 1; min-width: 320px; }
    .facture-section { flex: 2; background: #f4f8fb; border-radius: 12px; padding: 24px 32px; min-width: 400px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    h1 { color: #1a7ee7; font-size: 2.1rem; margin-bottom: 18px; letter-spacing: 1px; }
    label { font-weight: 500; margin-top: 12px; display: block; }
    input, textarea, select { width: 100%; padding: 8px 10px; margin-top: 4px; margin-bottom: 10px; border: 1px solid #c7e0f7; border-radius: 6px; font-size: 1rem; font-family: inherit; background: #fafdff; transition: border 0.2s; }
    input:disabled { background: #f5f5f5; color: #999; border: 1px solid #ddd; cursor: not-allowed; }
    input:focus, textarea:focus { border: 1.5px solid #1a7ee7; outline: none; }
    .btn { background: #1a7ee7; color: #fff; border: none; border-radius: 6px; padding: 10px 22px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; box-shadow: 0 2px 8px rgba(26,126,231,0.08); transition: background 0.2s; }
    .btn:hover { background: #1766b8; }
    .prestations-list { margin-bottom: 10px; }
    .prest-item { background: #eaf4fb; border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 0.98rem; }
    .prest-item span { flex: 1; }
    .prest-item button { background: none; border: none; color: #e74c3c; font-size: 1.2rem; cursor: pointer; margin-left: 8px; }
    @media (max-width: 900px) { .container { flex-direction: column; } .facture-section { min-width: unset; } }
    .facture { background: #fff; border-radius: 10px; padding: 28px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); color: #222; font-size: 0.75rem; max-width: 700px; margin: auto; }
    .facture-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
    .facture-title { font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, #ff6b9d, #c44569, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 1px; text-align: right; }
    .facture-info { font-size: 0.8rem; color: #222; margin-bottom: 4px; text-align: right; }
    .facture-emetteur { font-size: 0.8rem; color: #222; margin-bottom: 10px; font-weight: 400; line-height: 1.5; }
    .facture-client-box { background: #f4f4f4; border: 1.5px solid #e3eaf1; border-radius: 6px; padding: 14px 18px; margin: 24px 0 18px 0; }
    .facture-client-box b { font-size: 0.9rem; letter-spacing: 0.5px; }
    .facture-table { width: 100%; border-collapse: collapse; margin: 18px 0 10px 0; background: #fff; }
    .facture-table th, .facture-table td { border: 1px solid #222; padding: 6px 8px; text-align: left; font-size: 0.7rem; }
    .facture-table th { background: #f4f4f4; font-weight: 700; text-align: center; }
    .facture-table td { vertical-align: top; }
    .facture-total { text-align: right; font-size: 0.85rem; font-weight: 700; margin-top: 10px; margin-bottom: 10px; }
    .facture-paiement-box { background: #f4f4f4; border: 1.5px solid #e3eaf1; border-radius: 6px; padding: 14px 18px; margin: 28px 0 18px 0; }
    .facture-paiement-box b { font-size: 0.8rem; }
    .mentions { font-size: 0.7rem; color: #222; margin-top: 24px; border-top: 1px solid #e3eaf1; padding-top: 12px; }
    .facture-footer { margin-top: 18px; font-size: 0.98rem; }
    @media print { body, html { background: #fff !important; } .container { box-shadow: none !important; background: #fff !important; padding: 0 !important; margin: 0 !important; display: block !important; } .form-section, .prestations-list, .btn { display: none !important; } .facture-section { background: #fff !important; box-shadow: none !important; padding: 0 !important; min-width: unset !important; } .facture { box-shadow: none !important; margin: 0 auto !important; max-width: 100% !important; color: #222 !important; background: #fff !important; page-break-after: avoid; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-section">
      <h1>Nouvelle facture</h1>
      <form id="factureForm" autocomplete="off" onsubmit="return false;">
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations émetteur</h3>
        <label>Statut juridique</label>
        <select id="statutJuridique" onchange="changerStatut()" required>
          <option value="micro">Micro-entreprise</option>
          <option value="sasu">SASU</option>
          <option value="eurl">EURL</option>
        </select>
        <label>Nom de l'entreprise</label>
        <input type="text" id="emetteurNom" value="" required>
        <label>Contact</label>
        <input type="text" id="emetteurContact" value="" required>
        <label>Adresse</label>
        <textarea id="emetteurAdresse" rows="2" required></textarea>
        <label>SIRET</label>
        <input type="text" id="emetteurSiret" value="" required>
        <label>RCS</label>
        <input type="text" id="emetteurRcs" value="" required>
        <div id="champsSasu" style="display: none;">
          <label>Capital social (€)</label>
          <input type="number" id="capitalSocial" min="0" step="0.01">
          <label>N° TVA intracommunautaire</label>
          <input type="text" id="numTva" placeholder="FR12345678901">
          <label>Date de création SASU</label>
          <input type="date" id="dateCreationSasu">
        </div>
        <div id="champsEurl" style="display: none;">
          <label>Capital social EURL (€)</label>
          <input type="number" id="capitalSocialEurl" min="0" step="0.01">
          <label>N° TVA intracommunautaire</label>
          <input type="text" id="numTvaEurl" placeholder="FR12345678901">
          <label>Date de création EURL</label>
          <input type="date" id="dateCreationEurl">
          <label>Gérant</label>
          <input type="text" id="gerantEurl" placeholder="Nom du gérant">
          <label>Associé unique</label>
          <input type="text" id="associeUniqueEurl" placeholder="Nom de l'associé unique">
        </div>
        <label>Email</label>
        <input type="email" id="emetteurEmail" value="" required>
        <label>Téléphone</label>
        <input type="tel" id="emetteurTel" value="" required>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations facture</h3>
        <label>Numéro de facture</label>
        <input type="text" id="numFacture" value="F001" required>
        <label>Date</label>
        <input type="date" id="dateFacture" required>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations client</h3>
        <label>Nom du client</label>
        <input type="text" id="clientNom" required>
        <label>Adresse du client</label>
        <input type="text" id="clientAdresse" required>
        <label>Code postal & Ville</label>
        <input type="text" id="clientVille" required>
        <label>SIRET du client (optionnel)</label>
        <input type="text" id="clientSiret">
        <div id="champsClientSasu" style="display: none;">
          <label>N° TVA client (optionnel)</label>
          <input type="text" id="clientTva" placeholder="FR12345678901">
        </div>
        <label>Période facturée</label>
        <input type="text" id="periode" value="Juillet 2025" required>
        <label>Date de prestation</label>
        <input type="date" id="datePrestation" required>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Prestations</h3>
        <label>Ajouter une prestation</label>
        <input type="text" id="titrePresta" placeholder="Titre de la tâche">
        <input type="text" id="descPresta" placeholder="Description détaillée">
        <div style="display: flex; gap: 10px;">
          <input type="number" id="prixHT" placeholder="Prix HT (€)" min="0" step="0.01" style="flex: 1;" oninput="calculerTTCDepuisHT()">
          <input type="number" id="prixPresta" placeholder="Prix TTC (€)" min="0" step="0.01" style="flex: 1;" oninput="calculerHTDepuisTTC()" disabled>
        </div>
        <div id="infoTVA" style="font-size: 0.9rem; color: #666; margin-top: 5px; display: none;">
          Pour les SASU : vous pouvez saisir soit le prix HT soit le prix TTC, l'autre sera calculé automatiquement.
        </div>
        <div id="infoMicro" style="font-size: 0.9rem; color: #666; margin-top: 5px;">
          Pour les micro-entreprises : saisissez uniquement le prix HT (TVA non applicable).
        </div>
        <input type="number" id="qtePresta" placeholder="Quantité" min="1" step="1">
        <button class="btn" type="button" onclick="ajouterPrestation()">Ajouter</button>
        <div class="prestations-list" id="prestationsList"></div>
        <h3 style="color: #1a7ee7; margin-top: 20px; margin-bottom: 10px;">Informations bancaires</h3>
        <label>IBAN</label>
        <input type="text" id="iban" value="" required>
        <label>BIC</label>
        <input type="text" id="bic" value="" required>
        <label>Banque</label>
        <input type="text" id="banque" value="" required>
        <button class="btn" type="button" onclick="imprimerFacture()">Enregistrer en PDF</button>
      </form>
    </div>
    <div class="facture-section">
      <div id="factureApercu" class="facture"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="config.js"></script>
  <script>
    let prestations = [];
    
    function changerStatut() {
      const statut = document.getElementById('statutJuridique').value;
      const champsSasu = document.getElementById('champsSasu');
      const champsEurl = document.getElementById('champsEurl');
      const champsClientSasu = document.getElementById('champsClientSasu');
      const prixTTCInput = document.getElementById('prixPresta');
      const infoTVA = document.getElementById('infoTVA');
      const infoMicro = document.getElementById('infoMicro');
      
      if (statut === 'sasu') {
        champsSasu.style.display = 'block';
        champsEurl.style.display = 'none';
        champsClientSasu.style.display = 'block';
        prixTTCInput.disabled = false;
        infoTVA.style.display = 'block';
        infoMicro.style.display = 'none';
      } else if (statut === 'eurl') {
        champsSasu.style.display = 'none';
        champsEurl.style.display = 'block';
        champsClientSasu.style.display = 'block';
        prixTTCInput.disabled = false;
        infoTVA.style.display = 'block';
        infoMicro.style.display = 'none';
      } else {
        champsSasu.style.display = 'none';
        champsEurl.style.display = 'none';
        champsClientSasu.style.display = 'none';
        prixTTCInput.disabled = true;
        prixTTCInput.value = '';
        infoTVA.style.display = 'none';
        infoMicro.style.display = 'block';
      }
      
      // Recalculer les prix dans les champs de saisie si des valeurs sont présentes
      const prixTTC = document.getElementById('prixPresta').value;
      const prixHT = document.getElementById('prixHT').value;
      
      if (prixTTC && !isNaN(parseFloat(prixTTC))) {
        calculerHTDepuisTTC();
      } else if (prixHT && !isNaN(parseFloat(prixHT))) {
        calculerTTCDepuisHT();
      }
      
      // Rafraîchir l'affichage des prestations avec les bons labels
      afficherPrestations();
      majApercu();
    }
    
    function calculerTTCDepuisHT() {
      const prixHT = parseFloat(document.getElementById('prixHT').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      
      if (!isNaN(prixHT) && prixHT >= 0) {
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          const prixTTC = prixHT * 1.20; // TVA 20%
          document.getElementById('prixPresta').value = prixTTC.toFixed(2);
        } else {
          // Pour micro-entreprise, on ne calcule pas de TTC, on laisse vide
          document.getElementById('prixPresta').value = '';
        }
      } else if (prixHT === '' || isNaN(prixHT)) {
        document.getElementById('prixPresta').value = '';
      }
    }
    
    function calculerHTDepuisTTC() {
      const prixTTC = parseFloat(document.getElementById('prixPresta').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      
      if (!isNaN(prixTTC) && prixTTC >= 0) {
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          const prixHT = prixTTC / 1.20; // Déduction TVA 20%
          document.getElementById('prixHT').value = prixHT.toFixed(2);
        } else {
          // Pour micro-entreprise, TTC = HT (pas de TVA)
          document.getElementById('prixHT').value = prixTTC.toFixed(2);
        }
      } else if (prixTTC === '' || isNaN(prixTTC)) {
        document.getElementById('prixHT').value = '';
      }
    }
    
    function ajouterPrestation() {
      const titre = document.getElementById('titrePresta').value.trim();
      const desc = document.getElementById('descPresta').value.trim();
      const prixTTC = parseFloat(document.getElementById('prixPresta').value);
      const prixHT = parseFloat(document.getElementById('prixHT').value);
      const statutJuridique = document.getElementById('statutJuridique').value;
      let qte = 1;
      if (document.getElementById('qtePresta')) {
        qte = parseInt(document.getElementById('qtePresta').value) || 1;
      }
      
      // Vérifier qu'on a au moins un prix (HT ou TTC selon le statut)
      if (!titre || !desc) return;
      
      let prixFinal;
      if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
        // Pour SASU et EURL, on peut avoir HT ou TTC, on stocke le TTC
        if (!isNaN(prixTTC)) {
          prixFinal = prixTTC;
        } else if (!isNaN(prixHT)) {
          prixFinal = prixHT * 1.20; // Calculer TTC à partir de HT
        } else {
          return; // Pas de prix saisi
        }
      } else {
        // Pour micro-entreprise, seul le HT compte
        if (!isNaN(prixHT)) {
          prixFinal = prixHT;
        } else if (!isNaN(prixTTC)) {
          prixFinal = prixTTC; // TTC = HT pour micro-entreprise
        } else {
          return; // Pas de prix saisi
        }
      }
      
      prestations.push({ titre, desc, prix: prixFinal, qte });
      document.getElementById('titrePresta').value = '';
      document.getElementById('descPresta').value = '';
      document.getElementById('prixPresta').value = '';
      document.getElementById('prixHT').value = '';
      if (document.getElementById('qtePresta')) document.getElementById('qtePresta').value = '';
      afficherPrestations();
      majApercu();
    }
    function supprimerPrestation(idx) {
      prestations.splice(idx, 1);
      afficherPrestations();
      majApercu();
    }
    function afficherPrestations() {
      const list = document.getElementById('prestationsList');
      const statutJuridique = document.getElementById('statutJuridique').value;
      list.innerHTML = '';
      prestations.forEach((p, i) => {
        let prixLabel;
        if (statutJuridique === 'sasu' || statutJuridique === 'eurl') {
          prixLabel = `${p.prix.toFixed(2)} € TTC`;
        } else {
          prixLabel = `${p.prix.toFixed(2)} € HT`;
        }
        list.innerHTML += `<div class='prest-item'><span><b>${p.titre}</b><br>${p.desc} — <b>${prixLabel}</b></span><button onclick='supprimerPrestation(${i})' title='Supprimer'>&times;</button></div>`;
      });
    }
    function majApercu() {
      const statutJuridique = document.getElementById('statutJuridique').value;
      const numFacture = document.getElementById('numFacture').value;
      const dateFacture = document.getElementById('dateFacture').value;
      const clientNom = document.getElementById('clientNom').value;
      const clientAdresse = document.getElementById('clientAdresse').value;
      const clientVille = document.getElementById('clientVille').value;
      const clientSiret = document.getElementById('clientSiret').value;
      const periode = document.getElementById('periode').value;
      const iban = document.getElementById('iban').value;
      const bic = document.getElementById('bic').value;
      const banque = document.getElementById('banque').value;
      const emetteurNom = document.getElementById('emetteurNom').value;
      const emetteurContact = document.getElementById('emetteurContact').value;
      const emetteurAdresse = document.getElementById('emetteurAdresse').value;
      const emetteurSiret = document.getElementById('emetteurSiret').value;
      const emetteurRcs = document.getElementById('emetteurRcs').value;
      const emetteurEmail = document.getElementById('emetteurEmail').value;
      const emetteurTel = document.getElementById('emetteurTel').value;
      
      let echeance = '';
      if (dateFacture) {
        const d = new Date(dateFacture);
        d.setDate(d.getDate() + 30);
        echeance = d.toLocaleDateString('fr-FR');
      }
      
      const totalPrix = prestations.reduce((acc, p) => acc + (p.prix * (p.qte || 1)), 0);
      
      if (statutJuridique === 'sasu') {
        // Pour SASU, totalPrix = TTC
        genererFactureSASU(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalPrix);
      } else if (statutJuridique === 'eurl') {
        // Pour EURL, totalPrix = TTC
        genererFactureEURL(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalPrix);
      } else {
        // Pour micro-entreprise, totalPrix = HT
        genererFactureMicro(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalPrix);
      }
    }
    
    function genererFactureMicro(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalHT) {
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            ${emetteurContact}<br>
            ${emetteurAdresse.replace(/\n/g, '<br>')}<br>
            SIRET : ${emetteurSiret}<br>
            ${emetteurRcs}<br>
            Email : ${emetteurEmail}<br>
            Tél : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N° <b>${numFacture || ''}</b></div>
            <div class="facture-info">Date : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Échéance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>FACTURER À :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[NOM DU CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT si applicable]<br>'}
        </div>
        <table class="facture-table">
          <tr>
            <th>Description des prestations</th>
            <th>Période</th>
            <th>Quantité</th>
            <th>Prix unit. HT</th>
            <th>Total HT</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='5' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix; // Pour micro-entreprise, le prix stocké est HT
              const totalHT = prixHT * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} €</td><td style='text-align:right;'>${totalHT.toFixed(2)} €</td></tr>`;
            }).join('')}
        </table>
        <div class="facture-total">Total HT : ${totalHT.toFixed(2)} €<br>TVA : Non applicable<br><span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalHT.toFixed(2)} €</span></div>
        <div class="facture-paiement-box">
          <b>MODALITÉS DE PAIEMENT</b><br>
          Échéance : 30 jours à réception<br>
          <b>Mode de paiement :</b> Virement bancaire<br>
          <b>RIB :</b><br>
          IBAN : ${iban || '[VOTRE IBAN]'}<br>
          BIC : ${bic || '[VOTRE BIC]'}<br>
          Banque : ${banque || '[NOM DE VOTRE BANQUE]'}
        </div>
        <div class="mentions">
          <b>Mentions légales obligatoires :</b><br>
          • TVA non applicable, art. 293 B du CGI<br>
          • En cas de retard de paiement, indemnité forfaitaire de recouvrement : 40 €<br>
          • Taux de pénalité de retard : 3 fois le taux de l'intérêt légal<br>
          • Aucun escompte pour paiement anticipé
        </div>
      `;
    }
    
    function genererFactureEURL(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocialEurl = document.getElementById('capitalSocialEurl').value;
      const numTvaEurl = document.getElementById('numTvaEurl').value;
      const dateCreationEurl = document.getElementById('dateCreationEurl').value;
      const gerantEurl = document.getElementById('gerantEurl').value;
      const associeUniqueEurl = document.getElementById('associeUniqueEurl').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT à partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            <b>EURL au capital de ${capitalSocialEurl || '[CAPITAL]'} €</b><br><br>
            Siège social : ${emetteurAdresse.replace(/\n/g, '<br>')}<br><br>
            SIRET : ${emetteurSiret || '[SIRET EURL]'}<br>
            RCS Lyon : ${emetteurRcs || '[N° RCS]'}<br>
            N° TVA : ${numTvaEurl || '[N° TVA INTRA]'}<br><br>
            Gérant : ${gerantEurl || '[NOM GÉRANT]'}<br>
            Associé unique : ${associeUniqueEurl || '[NOM ASSOCIÉ]'}<br><br>
            Email : ${emetteurEmail}<br>
            Tél : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N° <b>${numFacture || '2025-001'}</b></div>
            <div class="facture-info">Date d'émission : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Date d'échéance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
            <div class="facture-info">Date de prestation : <b>${datePrestation || periode || '[PÉRIODE]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>ADRESSÉ À :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT]<br>'}
          ${clientTva ? `N° TVA : ${clientTva}<br>` : 'N° TVA : [N° TVA CLIENT si applicable]<br>'}
        </div>
        <table class="facture-table">
          <tr>
            <th>Description des prestations</th>
            <th>Période</th>
            <th>Qté</th>
            <th>Prix unit. HT</th>
            <th>Prix unit. TTC</th>
            <th>Total HT</th>
            <th>Total TTC</th>
          </tr>
          ${prestations.length === 0 ? `<tr><td colspan='7' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
            prestations.map(p => {
              const prixHT = p.prix / 1.20; // Pour EURL, HT = TTC / 1.20
              const totalHT = prixHT * (p.qte || 1);
              const totalTTC = p.prix * (p.qte || 1);
              return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} €</td><td style='text-align:right;'>${p.prix.toFixed(2)} €</td><td style='text-align:right;'>${totalHT.toFixed(2)} €</td><td style='text-align:right;'>${totalTTC.toFixed(2)} €</td></tr>`;
            }).join('')}
        </table>
        <div style="margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          • EURL assujettie à la TVA depuis le ${dateCreationEurl ? new Date(dateCreationEurl).toLocaleDateString('fr-FR') : '[DATE CRÉATION]'}<br>
          • Régime réel normal - Déclarations mensuelles<br>
          • Taux de TVA applicable : 20% (services aux entreprises)<br>
          • TVA sur les débits (facturation)
        </div>
        <div class="facture-total">
          Total HT : ${totalHT.toFixed(2)} €<br>
          TVA 20% : ${tva.toFixed(2)} €<br>
          <span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalTTC.toFixed(2)} €</span>
        </div>
        <div class="facture-paiement-box">
          <b>MODALITÉS DE PAIEMENT</b><br>
          Échéance : 30 jours nets à réception<br>
          Mode : Virement bancaire uniquement<br>
          Devise : Euro (EUR)<br>
          Domiciliation bancaire : France<br><br>
          <b>Coordonnées bancaires EURL :</b><br>
          IBAN : ${iban || '[IBAN EURL]'}<br>
          BIC : ${bic || '[BIC EURL]'}<br>
          Banque : ${banque || '[NOM BANQUE]'}<br>
          Titulaire : ${emetteurNom} EURL
        </div>
        <div class="mentions">
          <b>MENTIONS LÉGALES OBLIGATOIRES EURL :</b><br>
          • En cas de retard de paiement : indemnité forfaitaire de recouvrement de 40 €<br>
          • Pénalités de retard : 3 fois le taux de l'intérêt légal (soit 3,99% en 2025)<br>
          • Aucun escompte accordé pour paiement anticipé<br>
          • TVA sur les débits - Régime réel normal<br>
          • Responsabilité limitée aux apports - EURL unipersonnelle<br>
          • Gérance : ${gerantEurl || '[NOM GÉRANT]'} - Associé unique : ${associeUniqueEurl || '[NOM ASSOCIÉ]'}
        </div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666;">
          <b>${emetteurNom} EURL</b><br>
          EURL au capital de ${capitalSocialEurl || '[CAPITAL]'} € - RCS Lyon ${emetteurRcs || '[N° RCS]'} - SIRET ${emetteurSiret || '[SIRET]'} - N° TVA ${numTvaEurl || 'FR[N° TVA]'}<br>
          Gérant : ${gerantEurl || '[NOM GÉRANT]'} - Associé unique : ${associeUniqueEurl || '[NOM ASSOCIÉ]'}
        </div>
      `;
    }
    
    function genererFactureSASU(numFacture, dateFacture, echeance, clientNom, clientAdresse, clientVille, clientSiret, periode, iban, bic, banque, emetteurNom, emetteurContact, emetteurAdresse, emetteurSiret, emetteurRcs, emetteurEmail, emetteurTel, totalTTC) {
      const capitalSocial = document.getElementById('capitalSocial').value;
      const numTva = document.getElementById('numTva').value;
      const dateCreationSasu = document.getElementById('dateCreationSasu').value;
      const clientTva = document.getElementById('clientTva').value;
      const datePrestation = document.getElementById('datePrestation').value;
      
      const totalHT = totalTTC / 1.20; // Calcul HT à partir du TTC
      const tva = totalTTC - totalHT; // TVA = TTC - HT
      
      document.getElementById('factureApercu').innerHTML = `
        <div class="facture-header">
          <div class="facture-emetteur">
            <b style="font-size:1.3rem;">${emetteurNom}</b><br>
            <b>SASU au capital de ${capitalSocial || '[CAPITAL]'} €</b><br><br>
            Siège social : ${emetteurAdresse.replace(/\n/g, '<br>')}<br><br>
            SIRET : ${emetteurSiret || '[SIRET SASU]'}<br>
            RCS Lyon : ${emetteurRcs || '[N° RCS]'}<br>
            N° TVA : ${numTva || '[N° TVA INTRA]'}<br><br>
            Email : ${emetteurEmail}<br>
            Tél : ${emetteurTel}
          </div>
          <div style="text-align:right;min-width:220px;">
            <div class="facture-title">FACTURE</div>
            <div class="facture-info">N° <b>${numFacture || '2025-001'}</b></div>
            <div class="facture-info">Date d'émission : <b>${dateFacture || '[DATE]'}</b></div>
            <div class="facture-info">Date d'échéance : <b>${echeance || '[DATE + 30 jours]'}</b></div>
            <div class="facture-info">Date de prestation : <b>${datePrestation || periode || '[PÉRIODE]'}</b></div>
          </div>
        </div>
        <div class="facture-client-box">
          <b>ADRESSÉ À :</b><br>
          ${clientNom ? `<b>${clientNom}</b><br>` : '[RAISON SOCIALE CLIENT]<br>'}
          ${clientAdresse ? `${clientAdresse}<br>` : '[ADRESSE CLIENT]<br>'}
          ${clientVille ? `${clientVille}<br>` : '[CODE POSTAL VILLE CLIENT]<br>'}
          ${clientSiret ? `SIRET : ${clientSiret}<br>` : 'SIRET : [SIRET CLIENT]<br>'}
          ${clientTva ? `N° TVA : ${clientTva}<br>` : 'N° TVA : [N° TVA CLIENT si applicable]<br>'}
        </div>
                 <table class="facture-table">
           <tr>
             <th>Description des prestations</th>
             <th>Période</th>
             <th>Qté</th>
             <th>Prix unit. HT</th>
             <th>Prix unit. TTC</th>
             <th>Total HT</th>
             <th>Total TTC</th>
           </tr>
           ${prestations.length === 0 ? `<tr><td colspan='7' style='text-align:center;color:#aaa;'>Aucune prestation</td></tr>` :
             prestations.map(p => {
               const prixHT = p.prix / 1.20; // Pour SASU, HT = TTC / 1.20
               const totalHT = prixHT * (p.qte || 1);
               const totalTTC = p.prix * (p.qte || 1);
               return `<tr><td><b>${p.titre}</b><br>${p.desc.replace(/\n/g, '<br>')}</td><td>${periode}</td><td style='text-align:center;'>${p.qte || 1}</td><td style='text-align:right;'>${prixHT.toFixed(2)} €</td><td style='text-align:right;'>${p.prix.toFixed(2)} €</td><td style='text-align:right;'>${totalHT.toFixed(2)} €</td><td style='text-align:right;'>${totalTTC.toFixed(2)} €</td></tr>`;
             }).join('')}
         </table>
        <div style="margin: 20px 0;">
          <b>INFORMATIONS TVA :</b><br>
          • Assujetti à la TVA depuis le ${dateCreationSasu ? new Date(dateCreationSasu).toLocaleDateString('fr-FR') : '[DATE CRÉATION SASU]'}<br>
          • Taux de TVA applicable : 20%<br>
          • Facturation avec TVA obligatoire
        </div>
                 <div class="facture-total">
           Total HT : ${totalHT.toFixed(2)} €<br>
           TVA 20% : ${tva.toFixed(2)} €<br>
           <span style="font-size:1.25em; font-weight:800;">TOTAL TTC : ${totalTTC.toFixed(2)} €</span>
         </div>
        <div class="facture-paiement-box">
          <b>MODALITÉS DE PAIEMENT</b><br>
          Échéance : 30 jours nets<br>
          Mode : Virement bancaire<br>
          Devise : Euro (EUR)<br><br>
          <b>Coordonnées bancaires :</b><br>
          IBAN : ${iban || '[IBAN SASU]'}<br>
          BIC : ${bic || '[BIC SASU]'}<br>
          Banque : ${banque || '[NOM BANQUE]'}
        </div>
        <div class="mentions">
          <b>MENTIONS LÉGALES OBLIGATOIRES :</b><br>
          • En cas de retard de paiement, indemnité forfaitaire de recouvrement : 40 €<br>
          • Taux de pénalité de retard : 3 fois le taux de l'intérêt légal (soit 3,99% en 2025)<br>
          • Aucun escompte accordé pour paiement anticipé<br>
          • TVA sur les débits (encaissement)
        </div>
        <div style="text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666;">
          <b>${emetteurNom} SASU</b><br>
          SASU au capital de ${capitalSocial || '[CAPITAL]'} € - RCS Lyon ${emetteurRcs || '[N° RCS]'} - SIRET ${emetteurSiret || '[SIRET]'} - N° TVA ${numTva || 'FR[N° TVA]'}
        </div>
      `;
    }
    document.querySelectorAll('#factureForm input, #factureForm select').forEach(input => {
      input.addEventListener('input', majApercu);
    });
    function imprimerFacture() {
      majApercu();
      const element = document.getElementById('factureApercu');
      if (!element || !element.innerHTML.trim()) {
        alert("Aperçu vide !");
        return;
      }
      // Afficher la taille de l'élément pour debug
      console.log('Taille aperçu:', element.offsetWidth, element.offsetHeight);
      // Capturer l'aperçu en image
      html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        // Format A4 : 210 x 297 mm
        const pdf = new jspdf.jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 10; // marges de 10mm
        const usableWidth = pageWidth - (margin * 2);
        const usableHeight = pageHeight - (margin * 2);
        
        // Calculer la largeur optimale de l'image
        const imgWidth = usableWidth;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        // Si l'image tient dans une page
        if (imgHeight <= usableHeight) {
          const x = (pageWidth - imgWidth) / 2;
          const y = margin;
          pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        } else {
          // Si l'image dépasse une page, la diviser en plusieurs pages
          const ratio = canvas.width / canvas.height;
          const pageImgHeight = usableHeight;
          const pageImgWidth = pageImgHeight * ratio;
          
          // Calculer le nombre de pages nécessaires
          const totalPages = Math.ceil(imgHeight / usableHeight);
          
          console.log(`Document trop grand, division en ${totalPages} pages`);
          
          // Créer un canvas temporaire pour chaque page
          for (let pageNum = 0; pageNum < totalPages; pageNum++) {
            const startY = pageNum * usableHeight * (canvas.height / imgHeight);
            const sliceHeight = Math.min(usableHeight * (canvas.height / imgHeight), canvas.height - startY);
            
            // Créer un canvas pour cette portion
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = sliceHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Copier la portion de l'image originale
            tempCtx.drawImage(canvas, 0, startY, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
            
            // Ajouter une nouvelle page si ce n'est pas la première
            if (pageNum > 0) {
              pdf.addPage();
            }
            
            // Calculer les dimensions pour cette page
            const pageImgData = tempCanvas.toDataURL('image/jpeg', 1.0);
            const actualHeight = sliceHeight * imgWidth / canvas.width;
            const x = (pageWidth - imgWidth) / 2;
            const y = margin;
            
            pdf.addImage(pageImgData, 'JPEG', x, y, imgWidth, actualHeight);
            
            // Ajouter un numéro de page en bas de chaque page
            pdf.setFontSize(8);
            pdf.setTextColor(128, 128, 128);
            pdf.text(`Page ${pageNum + 1}/${totalPages}`, pageWidth - 20, pageHeight - 5);
          }
        }
        
        const numFacture = document.getElementById('numFacture').value || 'F001';
        const clientNom = document.getElementById('clientNom').value || 'CLIENT';
        // Nettoyer le nom du client pour le nom de fichier (supprimer espaces et caractères spéciaux)
        const clientNomClean = clientNom.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        const filename = `${numFacture}${clientNomClean}.pdf`;
        pdf.save(filename);
      }).catch(err => {
        console.error('Erreur lors de la génération du PDF:', err);
        alert('Erreur lors de la génération du PDF. Veuillez réessayer.');
      });
    }
    // Initialisation
    function initialiserFormulaire() {
      const aujourdhui = new Date().toISOString().split('T')[0];
      document.getElementById('dateFacture').value = aujourdhui;
      document.getElementById('datePrestation').value = aujourdhui;
      
      // Charger les valeurs de configuration si disponibles
      if (typeof CONFIG !== 'undefined') {
        document.getElementById('emetteurNom').value = CONFIG.emetteurNom || '';
        document.getElementById('emetteurContact').value = CONFIG.emetteurContact || '';
        document.getElementById('emetteurAdresse').value = CONFIG.emetteurAdresse || '';
        document.getElementById('emetteurSiret').value = CONFIG.emetteurSiret || '';
        document.getElementById('emetteurRcs').value = CONFIG.emetteurRcs || '';
        document.getElementById('emetteurEmail').value = CONFIG.emetteurEmail || '';
        document.getElementById('emetteurTel').value = CONFIG.emetteurTel || '';
        document.getElementById('iban').value = CONFIG.iban || '';
        document.getElementById('bic').value = CONFIG.bic || '';
        document.getElementById('banque').value = CONFIG.banque || '';
        
        // Valeurs spécifiques SASU
        if (CONFIG.capitalSocial) document.getElementById('capitalSocial').value = CONFIG.capitalSocial;
        if (CONFIG.numTva) document.getElementById('numTva').value = CONFIG.numTva;
        if (CONFIG.dateCreationSasu) document.getElementById('dateCreationSasu').value = CONFIG.dateCreationSasu;
        
        // Valeurs spécifiques EURL
        if (CONFIG.capitalSocialEurl) document.getElementById('capitalSocialEurl').value = CONFIG.capitalSocialEurl;
        if (CONFIG.numTvaEurl) document.getElementById('numTvaEurl').value = CONFIG.numTvaEurl;
        if (CONFIG.dateCreationEurl) document.getElementById('dateCreationEurl').value = CONFIG.dateCreationEurl;
        if (CONFIG.gerantEurl) document.getElementById('gerantEurl').value = CONFIG.gerantEurl;
        if (CONFIG.associeUniqueEurl) document.getElementById('associeUniqueEurl').value = CONFIG.associeUniqueEurl;
        
        if (CONFIG.statutJuridique) document.getElementById('statutJuridique').value = CONFIG.statutJuridique;
      }
      
      // Initialiser l'affichage des champs selon le statut
      changerStatut();
      majApercu();
    }
    initialiserFormulaire();
  </script>
  
  <div style="text-align: center; margin-top: 30px; padding: 20px; font-size: 0.9rem; color: #666; background: #f8f9fa; border-top: 1px solid #e9ecef;">
    Made with ❤️ by AllieEco
  </div>
</body>
</html> 