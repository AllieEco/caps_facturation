<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registre d'Achat - CAPSLOCK</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><style>.cls-1{fill:%23f4d03f;}.cls-2{fill:%23333;stroke:%23333;stroke-width:2;fill:none;}.cls-3{fill:%23333;}</style></defs><polygon class='cls-1' points='45,10 50,20 60,20 52,28 55,38 45,33 35,38 38,28 30,20 40,20'/><polygon class='cls-1' points='70,25 73,30 78,30 75,33 76,38 70,35 64,38 65,33 62,30 67,30'/><polygon class='cls-1' points='58,45 61,50 66,50 63,53 64,58 58,55 52,58 53,53 50,50 55,50'/><rect class='cls-2' x='15' y='25' width='45' height='60' rx='3'/><rect class='cls-3' x='20' y='35' width='25' height='2'/><rect class='cls-3' x='20' y='45' width='20' height='2'/><rect class='cls-3' x='20' y='55' width='25' height='2'/><rect class='cls-3' x='20' y='65' width='15' height='2'/><circle class='cls-2' cx='70' cy='60' r='15'/><text x='70' y='67' text-anchor='middle' class='cls-3' font-family='Arial' font-size='16' font-weight='bold'>$</text><path class='cls-2' d='M15,80 Q15,85 20,85 L75,85 Q80,85 80,80 L80,75 L15,75 Z'/></svg>" type="image/svg+xml">
  <link rel="stylesheet" href="../assets/css/footer-styles.css">
  <link rel="stylesheet" href="../assets/css/header-styles.css">
  <style>
    /* Variables CSS pour la coh√©rence des couleurs */
    :root {
      --primary-color: #1a7ee7;
      --primary-dark: #0f5bb8;
      --primary-light: #4a90e2;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --purple-color: #8e44ad;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --shadow-light: 0 2px 10px rgba(0,0,0,0.08);
      --shadow-medium: 0 4px 20px rgba(0,0,0,0.12);
      --shadow-heavy: 0 8px 30px rgba(0,0,0,0.15);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --gradient-danger: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      --gradient-purple: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-card: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    }

    * {
      box-sizing: border-box;
    }

    body { 
      font-family: 'Montserrat', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      margin: 0; 
      padding: 0; 
      color: var(--text-dark);
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container { 
      max-width: 1200px; 
      margin: 40px auto; 
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px; 
      box-shadow: var(--shadow-heavy); 
      padding: 40px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 1;
      animation: fadeInUp 0.8s ease-out;
    }

    h1 { 
      color: white; 
      font-size: 3rem; 
      margin-bottom: 30px; 
      text-align: center; 
      letter-spacing: 1px;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }

    .title-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h1::before {
      content: "üõí";
      display: block;
      font-size: 3.5rem;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    h2 { 
      color: var(--text-dark); 
      font-size: 2rem; 
      margin-bottom: 24px; 
      margin-top: 40px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 60px;
      height: 3px;
      background: var(--gradient-danger);
      border-radius: 2px;
    }

    h3 { 
      color: var(--text-dark); 
      font-size: 1.4rem; 
      margin-bottom: 16px; 
      margin-top: 30px;
      font-weight: 600;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn { 
      background: var(--gradient-danger); 
      color: #fff; 
      border: none; 
      border-radius: 12px; 
      padding: 14px 28px; 
      font-size: 1.1rem; 
      font-weight: 600; 
      cursor: pointer; 
      margin: 8px 4px; 
      box-shadow: var(--shadow-light); 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .btn-success { 
      background: var(--gradient-success); 
    }

    .btn-success:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .btn-danger { 
      background: var(--gradient-danger); 
    }

    .btn-danger:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .btn-secondary { 
      background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
    }

    .btn-secondary:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .form-group { 
      margin-bottom: 24px; 
    }

    .form-row { 
      display: flex; 
      gap: 20px; 
      margin-bottom: 20px; 
    }

    .form-row > div { 
      flex: 1; 
    }

    label { 
      font-weight: 600; 
      margin-bottom: 8px; 
      display: block; 
      color: var(--text-dark);
      font-size: 1.1rem;
    }

    input, select, textarea { 
      width: 100%; 
      padding: 14px 16px; 
      border: 2px solid rgba(255, 255, 255, 0.3); 
      border-radius: 12px; 
      font-size: 1rem; 
      font-family: inherit; 
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-dark);
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus { 
      border: 2px solid var(--danger-color); 
      outline: none;
      box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
      transform: translateY(-2px);
    }

    .table-container { 
      overflow-x: auto; 
      margin: 30px 0;
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-medium);
      max-height: 500px;
      overflow-y: auto;
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: var(--shadow-light);
      font-size: 0.9rem;
    }

    th, td { 
      padding: 12px 8px; 
      text-align: left; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
      white-space: nowrap;
    }

    th { 
      background: var(--gradient-danger); 
      font-weight: 700; 
      color: white;
      font-size: 0.85rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover { 
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.01);
      transition: all 0.3s ease;
    }

    /* Colonnes sp√©cifiques pour optimiser l'espace */
    .col-date { width: 100px; }
    .col-num { width: 120px; }
    .col-fournisseur { width: 150px; }
    .col-categorie { width: 120px; }
    .col-montant { width: 100px; text-align: right; }
    .col-tva { width: 80px; text-align: right; }
    .col-total { width: 100px; text-align: right; }
    .col-actions { width: 80px; text-align: center; }

    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 24px; 
      margin: 40px 0;
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .stat-card { 
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      padding: 32px; 
      border-radius: 20px; 
      text-align: center; 
      box-shadow: var(--shadow-medium);
      border: 1px solid #a93226;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #ffffff;
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-heavy);
      background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
      border: 1px solid #922b21;
    }

    .stat-card h3 { 
      margin: 0 0 16px 0; 
      font-size: 1.3rem; 
      color: white;
      font-weight: 600;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .stat-card .value { 
      font-size: 2.8rem; 
      font-weight: 800; 
      margin-bottom: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-card .label { 
      font-size: 1rem; 
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      text-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }



    .empty-state { 
      text-align: center; 
      padding: 80px 20px; 
      color: var(--text-light);
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      margin: 30px 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .empty-state i { 
      font-size: 4rem; 
      margin-bottom: 20px; 
      color: var(--danger-color);
      animation: float 3s ease-in-out infinite;
    }

    .filters { 
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 30px; 
      border-radius: 16px; 
      margin-bottom: 30px;
      box-shadow: var(--shadow-medium);
    }

    .filters h3 { 
      margin-top: 0;
      color: var(--text-dark);
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .filters input, .filters select, .filters textarea { 
      width: 100%; 
      padding: 14px 16px; 
      border: 2px solid #e74c3c; 
      border-radius: 12px; 
      font-size: 1rem; 
      font-family: inherit; 
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-dark);
      box-sizing: border-box;
    }

    .filters input:focus, .filters select:focus, .filters textarea:focus { 
      border: 2px solid #c0392b; 
      outline: none;
      box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
      transform: translateY(-2px);
      background: #ffffff;
    }

    .total-row { 
      font-weight: 700; 
      background: var(--gradient-danger) !important; 
      color: white !important;
    }

    .amount-negative { 
      color: var(--danger-color); 
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
    }

    .amount-positive { 
      color: var(--success-color); 
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
    }

    /* Effet de particules flottantes */
    .floating-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }
    
    .particle:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
    .particle:nth-child(2) { top: 60%; left: 80%; animation-delay: 2s; }
    .particle:nth-child(3) { top: 40%; left: 60%; animation-delay: 4s; }
    .particle:nth-child(4) { top: 80%; left: 20%; animation-delay: 1s; }
    .particle:nth-child(5) { top: 30%; left: 90%; animation-delay: 3s; }

    @media (max-width: 768px) {
      .container { 
        margin: 20px; 
        padding: 30px 20px; 
      }
      
      .form-row { 
        flex-direction: column; 
        gap: 0; 
      }
      
      .stats-grid { 
        grid-template-columns: repeat(4, 1fr); 
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      
      .stat-card {
        min-width: 200px;
        padding: 20px 16px;
      }
      
      .header-buttons { 
        flex-direction: column; 
        gap: 8px;
        margin-right: 20px;
      }
      
      .header-logo { 
        margin-left: 20px;
        height: 50px;
      }
      
      .main-header {
        height: 70px;
      }
      
      h1 {
        font-size: 2.5rem;
      }
      
      h1::before {
        font-size: 3rem;
      }
      
      .stat-card {
        padding: 24px 20px;
      }
      
      .stat-card .value {
        font-size: 2.2rem;
      }
      
      .filters {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Particules flottantes pour l'effet de fond -->
  <div class="floating-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>
  
  <header class="main-header">
    <img src="../assets/images/logo_capslock.png" alt="Logo CAPSLOCK" class="header-logo" onclick="window.location.href='../index.html'">
    <div class="header-buttons">
      <button class="header-button" onclick="window.location.href='facture.html'">Devis/Facture</button>
      <button class="header-button" onclick="window.location.href='factur_x.html'">Factur-X</button>
      <button class="header-button active">Registre d'achat</button>
      <button class="header-button" onclick="window.location.href='livre_recette.html'">Livre de recette</button>
    </div>
  </header>

  <div class="container">
    <h1>üõí <span class="title-text">Registre d'Achat</span></h1>
    
    <!-- Statistiques -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total des achats</h3>
        <div class="value" id="totalAchats">0,00 ‚Ç¨</div>
        <div class="label">Toutes p√©riodes</div>
      </div>
      <div class="stat-card">
        <h3>Achats ce mois</h3>
        <div class="value" id="achatsMois">0,00 ‚Ç¨</div>
        <div class="label" id="labelMois">Janvier 2025</div>
      </div>
      <div class="stat-card">
        <h3>Nombre de factures</h3>
        <div class="value" id="nombreFactures">0</div>
        <div class="label">Factures d'achat</div>
      </div>
      <div class="stat-card">
        <h3>Achat moyen</h3>
        <div class="value" id="achatMoyen">0,00 ‚Ç¨</div>
        <div class="label">Par facture</div>
      </div>
    </div>

    <!-- Formulaire d'ajout -->
    <h2>‚ûï Enregistrer un achat</h2>
    <form id="achatForm">
      <div class="form-row">
        <div>
          <label for="dateAchat">Date d'achat</label>
          <input type="date" id="dateAchat" required>
        </div>
        <div>
          <label for="numeroFacture">Num√©ro de facture</label>
          <input type="text" id="numeroFacture" placeholder="FA001" required>
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label for="fournisseurNom">Fournisseur</label>
          <input type="text" id="fournisseurNom" placeholder="Nom du fournisseur" required>
        </div>
        <div>
          <label for="categorieAchat">Cat√©gorie</label>
          <select id="categorieAchat" required>
            <option value="">S√©lectionnez une cat√©gorie</option>
            <option value="fournitures">Fournitures de bureau</option>
            <option value="equipement">√âquipement informatique</option>
            <option value="services">Services</option>
            <option value="marketing">Marketing & Communication</option>
            <option value="formation">Formation</option>
            <option value="transport">Transport & D√©placement</option>
            <option value="assurance">Assurance</option>
            <option value="loyer">Loyer & Charges</option>
            <option value="telephonie">T√©l√©phonie & Internet</option>
            <option value="autres">Autres</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label for="montantHT">Montant HT (‚Ç¨)</label>
          <input type="number" id="montantHT" step="0.01" min="0" placeholder="0.00" required>
        </div>
        <div>
          <label for="tauxTva">Taux TVA (%)</label>
          <select id="tauxTva" required>
            <option value="0">0% (Exon√©r√©)</option>
            <option value="20">20% (Taux normal)</option>
            <option value="10">10% (Taux r√©duit)</option>
            <option value="5.5">5,5% (Taux super r√©duit)</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label for="montantTTC">Montant TTC (‚Ç¨)</label>
          <input type="number" id="montantTTC" step="0.01" min="0" placeholder="0.00" readonly>
        </div>
        <div>
          <label for="typePrestation">Type de prestation (obligatoire 2026)</label>
          <select id="typePrestation" required>
            <option value="">S√©lectionnez le type</option>
            <option value="bien">Bien</option>
            <option value="service">Service</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label for="modePaiement">Mode de paiement</label>
          <select id="modePaiement" required>
            <option value="virement">Virement bancaire</option>
            <option value="carte">Carte bancaire</option>
            <option value="cheque">Ch√®que</option>
            <option value="espece">Esp√®ce</option>
            <option value="prelevement">Pr√©l√®vement</option>
          </select>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
            <strong>Nouvelle obligation 2026 :</strong> La loi fran√ßaise exige maintenant de pr√©ciser si chaque prestation est un bien ou un service.
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label for="datePaiement">Date de paiement</label>
          <input type="date" id="datePaiement">
        </div>
        <div>
          <label for="deductible">D√©ductible fiscalement</label>
          <select id="deductible">
            <option value="oui">Oui</option>
            <option value="non">Non</option>
            <option value="partiel">Partiellement</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="descriptionAchat">Description (optionnel)</label>
        <textarea id="descriptionAchat" rows="3" placeholder="D√©tails de l'achat..."></textarea>
      </div>
      
      <button type="submit" class="btn btn-success">Enregistrer l'achat</button>
    </form>

    <!-- Filtres -->
    <div class="filters">
      <h3>üîç Filtres</h3>
      <div class="form-row">
        <div>
          <label for="filtreAnnee">Ann√©e</label>
          <select id="filtreAnnee">
            <option value="">Toutes les ann√©es</option>
          </select>
        </div>
        <div>
          <label for="filtreMois">Mois</label>
          <select id="filtreMois">
            <option value="">Tous les mois</option>
            <option value="01">Janvier</option>
            <option value="02">F√©vrier</option>
            <option value="03">Mars</option>
            <option value="04">Avril</option>
            <option value="05">Mai</option>
            <option value="06">Juin</option>
            <option value="07">Juillet</option>
            <option value="08">Ao√ªt</option>
            <option value="09">Septembre</option>
            <option value="10">Octobre</option>
            <option value="11">Novembre</option>
            <option value="12">D√©cembre</option>
          </select>
        </div>
        <div>
          <label for="filtreCategorie">Cat√©gorie</label>
          <select id="filtreCategorie">
            <option value="">Toutes les cat√©gories</option>
            <option value="fournitures">Fournitures de bureau</option>
            <option value="equipement">√âquipement informatique</option>
            <option value="services">Services</option>
            <option value="marketing">Marketing & Communication</option>
            <option value="formation">Formation</option>
            <option value="transport">Transport & D√©placement</option>
            <option value="assurance">Assurance</option>
            <option value="loyer">Loyer & Charges</option>
            <option value="telephonie">T√©l√©phonie & Internet</option>
            <option value="autres">Autres</option>
          </select>
        </div>
        <div>
          <label for="filtreFournisseur">Fournisseur</label>
          <input type="text" id="filtreFournisseur" placeholder="Nom du fournisseur">
        </div>
        <div style="display: flex; align-items: end;">
          <button type="button" class="btn btn-secondary" onclick="reinitialiserFiltres()">R√©initialiser</button>
        </div>
      </div>
    </div>

    <!-- Tableau des achats -->
    <h2>üìã Historique des achats</h2>
    <div class="table-container">
      <table id="achatsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>N¬∞ Facture</th>
            <th>Fournisseur</th>
            <th>Cat√©gorie</th>
            <th>Type</th>
            <th>Montant HT</th>
            <th>TVA</th>
            <th>Montant TTC</th>
            <th>Mode paiement</th>
            <th>D√©ductible</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="achatsTableBody">
          <tr>
            <td colspan="10" class="empty-state">
              <div>
                <i>üõí</i>
                <p>Aucun achat enregistr√©</p>
                <p>Commencez par enregistrer votre premier achat ci-dessus</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Boutons d'export -->
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn" onclick="exporterCSV()">üìä Exporter en CSV</button>
      <button class="btn" onclick="exporterPDF()">üìÑ Exporter en PDF</button>
      <button class="btn btn-danger" onclick="viderRegistre()">üóëÔ∏è Vider le registre</button>
    </div>
  </div>

  <div class="footer">
    Made with ‚ù§Ô∏è by <a href="https://github.com/AllieEco" target="_blank">AllieEco</a>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="../config/config.js"></script>
  <script>
    let achats = JSON.parse(localStorage.getItem('achats')) || [];
    let achatsFiltered = [...achats];

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateAchat').value = today;
      document.getElementById('datePaiement').value = today;
      document.getElementById('deductible').value = 'oui';
      
      // Calculer automatiquement le TTC
      document.getElementById('montantHT').addEventListener('input', calculerTTC);
      document.getElementById('tauxTva').addEventListener('change', calculerTTC);
      
      // Filtres
      document.getElementById('filtreAnnee').addEventListener('change', appliquerFiltres);
      document.getElementById('filtreMois').addEventListener('change', appliquerFiltres);
      document.getElementById('filtreCategorie').addEventListener('change', appliquerFiltres);
      document.getElementById('filtreFournisseur').addEventListener('input', appliquerFiltres);
      
      // Remplir les ann√©es disponibles
      remplirAnnees();
      
      // Charger les donn√©es
      afficherAchats();
      mettreAJourStatistiques();
    });

    // Gestionnaire du formulaire
    document.getElementById('achatForm').addEventListener('submit', function(e) {
      e.preventDefault();
      ajouterAchat();
    });

    function calculerTTC() {
      const montantHT = parseFloat(document.getElementById('montantHT').value) || 0;
      const tauxTva = parseFloat(document.getElementById('tauxTva').value) || 0;
      const montantTTC = montantHT * (1 + tauxTva / 100);
      document.getElementById('montantTTC').value = montantTTC.toFixed(2);
    }

    function ajouterAchat() {
      const achat = {
        id: Date.now(),
        date: document.getElementById('dateAchat').value,
        numeroFacture: document.getElementById('numeroFacture').value,
        fournisseur: document.getElementById('fournisseurNom').value,
        categorie: document.getElementById('categorieAchat').value,
        typePrestation: document.getElementById('typePrestation').value,
        montantHT: parseFloat(document.getElementById('montantHT').value),
        tauxTva: parseFloat(document.getElementById('tauxTva').value),
        montantTTC: parseFloat(document.getElementById('montantTTC').value),
        modePaiement: document.getElementById('modePaiement').value,
        datePaiement: document.getElementById('datePaiement').value,
        deductible: document.getElementById('deductible').value,
        description: document.getElementById('descriptionAchat').value
      };
      
      achats.push(achat);
      localStorage.setItem('achats', JSON.stringify(achats));
      
      // R√©initialiser le formulaire
      document.getElementById('achatForm').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateAchat').value = today;
      document.getElementById('datePaiement').value = today;
      document.getElementById('deductible').value = 'oui';
      document.getElementById('montantTTC').value = '';
      
      // Rafra√Æchir l'affichage
      achatsFiltered = [...achats];
      afficherAchats();
      mettreAJourStatistiques();
      remplirAnnees();
      
      alert('Achat enregistr√© avec succ√®s !');
    }

    function supprimerAchat(id) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer cet achat ?')) {
        achats = achats.filter(a => a.id !== id);
        localStorage.setItem('achats', JSON.stringify(achats));
        achatsFiltered = [...achats];
        afficherAchats();
        mettreAJourStatistiques();
        remplirAnnees();
      }
    }

    function afficherAchats() {
      const tbody = document.getElementById('achatsTableBody');
      
      if (achatsFiltered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="empty-state">
              <div>
                <i>üõí</i>
                <p>Aucun achat trouv√©</p>
                <p>Modifiez vos filtres ou ajoutez un nouvel achat</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Trier par date d√©croissante
      achatsFiltered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      tbody.innerHTML = achatsFiltered.map(achat => {
        const typeLabel = achat.typePrestation === 'bien' ? 'üõçÔ∏è Bien' : 'üîß Service';
        return `
        <tr>
          <td>${new Date(achat.date).toLocaleDateString('fr-FR')}</td>
          <td><strong>${achat.numeroFacture}</strong></td>
          <td>${achat.fournisseur}</td>
          <td>${getCategorieLabel(achat.categorie)}</td>
          <td style="text-align:center;">${typeLabel}</td>
          <td class="amount-negative">${achat.montantHT.toFixed(2)} ‚Ç¨</td>
          <td>${achat.tauxTva}%</td>
          <td class="amount-negative"><strong>${achat.montantTTC.toFixed(2)} ‚Ç¨</strong></td>
          <td>${getModePaiementLabel(achat.modePaiement)}</td>
          <td>${getDeductibleLabel(achat.deductible)}</td>
          <td>
            <button class="btn btn-danger" onclick="supprimerAchat(${achat.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `;
      }).join('');

      // Ajouter une ligne de total
      const totalHT = achatsFiltered.reduce((sum, a) => sum + a.montantHT, 0);
      const totalTTC = achatsFiltered.reduce((sum, a) => sum + a.montantTTC, 0);
      const totalTVA = totalTTC - totalHT;
      
      tbody.innerHTML += `
        <tr class="total-row">
          <td colspan="5"><strong>TOTAL</strong></td>
          <td><strong>${totalHT.toFixed(2)} ‚Ç¨</strong></td>
          <td><strong>${totalTVA.toFixed(2)} ‚Ç¨</strong></td>
          <td><strong>${totalTTC.toFixed(2)} ‚Ç¨</strong></td>
          <td colspan="3"></td>
        </tr>
      `;
    }

    function mettreAJourStatistiques() {
      const totalAchats = achats.reduce((sum, a) => sum + a.montantTTC, 0);
      const nombreFactures = achats.length;
      const achatMoyen = nombreFactures > 0 ? totalAchats / nombreFactures : 0;
      
      // Achats du mois en cours
      const maintenant = new Date();
      const moisActuel = maintenant.getMonth();
      const anneeActuelle = maintenant.getFullYear();
      const achatsMois = achats.filter(a => {
        const dateAchat = new Date(a.date);
        return dateAchat.getMonth() === moisActuel && dateAchat.getFullYear() === anneeActuelle;
      }).reduce((sum, a) => sum + a.montantTTC, 0);
      
      document.getElementById('totalAchats').textContent = totalAchats.toFixed(2) + ' ‚Ç¨';
      document.getElementById('achatsMois').textContent = achatsMois.toFixed(2) + ' ‚Ç¨';
      document.getElementById('nombreFactures').textContent = nombreFactures;
      document.getElementById('achatMoyen').textContent = achatMoyen.toFixed(2) + ' ‚Ç¨';
      
      // Mettre √† jour le label du mois
      const nomsMois = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                       'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      document.getElementById('labelMois').textContent = nomsMois[moisActuel] + ' ' + anneeActuelle;
    }

    function remplirAnnees() {
      const select = document.getElementById('filtreAnnee');
      const annees = [...new Set(achats.map(a => new Date(a.date).getFullYear()))].sort((a, b) => b - a);
      
      const optionsExistantes = Array.from(select.options).map(o => o.value);
      
      annees.forEach(annee => {
        if (!optionsExistantes.includes(annee.toString())) {
          const option = document.createElement('option');
          option.value = annee;
          option.textContent = annee;
          select.appendChild(option);
        }
      });
    }

    function appliquerFiltres() {
      const filtreAnnee = document.getElementById('filtreAnnee').value;
      const filtreMois = document.getElementById('filtreMois').value;
      const filtreCategorie = document.getElementById('filtreCategorie').value;
      const filtreFournisseur = document.getElementById('filtreFournisseur').value.toLowerCase();
      
      achatsFiltered = achats.filter(achat => {
        const dateAchat = new Date(achat.date);
        const anneeAchat = dateAchat.getFullYear().toString();
        const moisAchat = (dateAchat.getMonth() + 1).toString().padStart(2, '0');
        
        return (!filtreAnnee || anneeAchat === filtreAnnee) &&
               (!filtreMois || moisAchat === filtreMois) &&
               (!filtreCategorie || achat.categorie === filtreCategorie) &&
               (!filtreFournisseur || achat.fournisseur.toLowerCase().includes(filtreFournisseur));
      });
      
      afficherAchats();
    }

    function reinitialiserFiltres() {
      document.getElementById('filtreAnnee').value = '';
      document.getElementById('filtreMois').value = '';
      document.getElementById('filtreCategorie').value = '';
      document.getElementById('filtreFournisseur').value = '';
      achatsFiltered = [...achats];
      afficherAchats();
    }

    function getCategorieLabel(categorie) {
      const labels = {
        'fournitures': 'Fournitures de bureau',
        'equipement': '√âquipement informatique',
        'services': 'Services',
        'marketing': 'Marketing & Communication',
        'formation': 'Formation',
        'transport': 'Transport & D√©placement',
        'assurance': 'Assurance',
        'loyer': 'Loyer & Charges',
        'telephonie': 'T√©l√©phonie & Internet',
        'autres': 'Autres'
      };
      return labels[categorie] || categorie;
    }

    function getModePaiementLabel(mode) {
      const labels = {
        'virement': 'Virement',
        'carte': 'Carte',
        'cheque': 'Ch√®que',
        'espece': 'Esp√®ce',
        'prelevement': 'Pr√©l√®vement'
      };
      return labels[mode] || mode;
    }

    function getDeductibleLabel(deductible) {
      const labels = {
        'oui': 'Oui',
        'non': 'Non',
        'partiel': 'Partiel'
      };
      return labels[deductible] || deductible;
    }

    function exporterCSV() {
      if (achatsFiltered.length === 0) {
        alert('Aucun achat √† exporter');
        return;
      }
      
      let csvContent = '\uFEFF'; // BOM UTF-8
      csvContent += 'Date,Num√©ro Facture,Fournisseur,Cat√©gorie,Type Prestation,Montant HT,Taux TVA,Montant TTC,Mode Paiement,Date Paiement,D√©ductible,Description\n';
      
      achatsFiltered.forEach(achat => {
        const typeLabel = achat.typePrestation === 'bien' ? 'Bien' : 'Service';
        csvContent += `${achat.date},${achat.numeroFacture},"${achat.fournisseur}","${getCategorieLabel(achat.categorie)}","${typeLabel}",${achat.montantHT.toFixed(2)},${achat.tauxTva},${achat.montantTTC.toFixed(2)},${getModePaiementLabel(achat.modePaiement)},${achat.datePaiement || ''},${getDeductibleLabel(achat.deductible)},"${achat.description || ''}"\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `registre_achats_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exporterPDF() {
      if (achats.length === 0) {
        alert('Aucun achat √† exporter en PDF');
        return;
      }

      // V√©rifier si CONFIG est disponible
      if (typeof CONFIG === 'undefined') {
        alert('Configuration manquante. Veuillez cr√©er le fichier config/config.js');
        return;
      }

      // Cr√©er une nouvelle instance jsPDF en format paysage
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' = landscape (paysage)
      
      // Fonction locale pour les labels
      function getCategorieLabel(categorie) {
        const labels = {
          'fournitures': 'Fournitures de bureau',
          'equipement': '√âquipement informatique',
          'services': 'Services',
          'marketing': 'Marketing & Communication',
          'formation': 'Formation',
          'transport': 'Transport & D√©placement',
          'assurance': 'Assurance',
          'loyer': 'Loyer & Charges',
          'telephonie': 'T√©l√©phonie & Internet',
          'autres': 'Autres'
        };
        return labels[categorie] || categorie;
      }
      
      function getModePaiementLabel(mode) {
        const labels = {
          'virement': 'Virement',
          'carte': 'Carte',
          'cheque': 'Ch√®que',
          'espece': 'Esp√®ce',
          'prelevement': 'Pr√©l√®vement'
        };
        return labels[mode] || mode;
      }
      
      // Param√®tres g√©n√©raux - Format paysage A4 : 297 x 210 mm
      const pageWidth = 297;
      const pageHeight = 210;
      const margin = 15;
      const usableWidth = pageWidth - (margin * 2);
      
      // Obtenir l'ann√©e √† afficher
      const filtreAnnee = document.getElementById('filtreAnnee').value;
      const anneeAffichage = filtreAnnee || new Date().getFullYear().toString();
      
      // R√©cup√©rer les informations de l'entreprise depuis CONFIG
      const nomEntreprise = CONFIG.emetteurNom || 'Entreprise';
      const siret = CONFIG.emetteurSiret || '[SIRET]';
      const statutJuridique = CONFIG.statutJuridique || 'micro';
      
      // D√©terminer le nom de l'entrepreneur selon le statut
      let nomEntrepreneur = '[NOM ENTREPRENEUR]';
      if (statutJuridique === 'sasu') {
        nomEntrepreneur = CONFIG.presidentSasu || '[PR√âSIDENT SASU]';
      } else if (statutJuridique === 'eurl') {
        nomEntrepreneur = CONFIG.gerantEurl || '[G√âRANT EURL]';
      } else {
        nomEntrepreneur = CONFIG.emetteurContact || '[ENTREPRENEUR]';
      }
      
      let currentY = margin;
      
      // Fonction pour ajouter une nouvelle page si n√©cessaire
      function checkNewPage(neededSpace = 40) {
        if (currentY + neededSpace > pageHeight - margin) {
          pdf.addPage();
          currentY = margin;
          return true;
        }
        return false;
      }
      
      // En-t√™te du document
      pdf.setFontSize(24);
      pdf.setFont('helvetica', 'bold');
      pdf.text('REGISTRE D\'ACHAT', pageWidth / 2, currentY, { align: 'center' });
      currentY += 15;
      
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text(nomEntreprise, pageWidth / 2, currentY, { align: 'center' });
      currentY += 10;
      
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'normal');
      pdf.text(`Entrepreneur : ${nomEntrepreneur}`, pageWidth / 2, currentY, { align: 'center' });
      currentY += 8;
      
      pdf.text(`SIRET : ${siret}`, pageWidth / 2, currentY, { align: 'center' });
      currentY += 8;
      
      pdf.setFont('helvetica', 'bold');
      pdf.text(`ANN√âE ${anneeAffichage}`, pageWidth / 2, currentY, { align: 'center' });
      currentY += 20;
      
      // Ligne de s√©paration
      pdf.setLineWidth(0.5);
      pdf.line(margin, currentY, pageWidth - margin, currentY);
      currentY += 15;
      
      // Filtrer les achats pour l'ann√©e s√©lectionn√©e
      const achatsAnnee = achats.filter(achat => {
        const dateAchat = new Date(achat.date);
        return dateAchat.getFullYear().toString() === anneeAffichage;
      });
      
      // Organiser les achats par mois
      const moisNoms = [
        'JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN',
        'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'
      ];
      
      const achatsParMois = {};
      for (let i = 0; i < 12; i++) {
        achatsParMois[i] = [];
      }
      
      // R√©partir les achats par mois
      achatsAnnee.forEach(achat => {
        const dateAchat = new Date(achat.date);
        const mois = dateAchat.getMonth();
        achatsParMois[mois].push(achat);
      });
      
      // Fonction pour diviser le texte en lignes selon la largeur de colonne
      function diviserTexte(texte, largeurMax, fontSize = 9) {
        if (!texte) return [''];
        
        pdf.setFontSize(fontSize);
        const texteStr = texte.toString();
        const largeurColonne = largeurMax - 6; // Marge interne de 3mm de chaque c√¥t√©
        
        // Si le texte tient sur une ligne
        if (pdf.getTextWidth(texteStr) <= largeurColonne) {
          return [texteStr];
        }
        
        const mots = texteStr.split(' ');
        const lignes = [];
        let ligneActuelle = '';
        
        for (let mot of mots) {
          const testLigne = ligneActuelle + (ligneActuelle ? ' ' : '') + mot;
          
          if (pdf.getTextWidth(testLigne) <= largeurColonne) {
            ligneActuelle = testLigne;
          } else {
            if (ligneActuelle) {
              lignes.push(ligneActuelle);
              ligneActuelle = mot;
            } else {
              // Mot trop long, le couper
              while (mot.length > 0) {
                let partieVisible = mot;
                while (pdf.getTextWidth(partieVisible) > largeurColonne && partieVisible.length > 1) {
                  partieVisible = partieVisible.slice(0, -1);
                }
                lignes.push(partieVisible);
                mot = mot.slice(partieVisible.length);
              }
              ligneActuelle = '';
            }
          }
        }
        
        if (ligneActuelle) {
          lignes.push(ligneActuelle);
        }
        
        return lignes.length > 0 ? lignes : [''];
      }
      
      // Fonction pour calculer la hauteur n√©cessaire pour une rang√©e
      function calculerHauteurRangee(rowData, fontSize = 9) {
        let maxLignes = 1;
        
        rowData.forEach((cellData, i) => {
          const colWidths = [22, 26, 40, 35, 28, 30, 28, 25, 25]; // Largeurs colonnes
          const lignes = diviserTexte(cellData, colWidths[i], fontSize);
          maxLignes = Math.max(maxLignes, lignes.length);
        });
        
        return Math.max(10, maxLignes * 5 + 4); // 10mm minimum, 5mm par ligne + marge
      }
      
      // G√©n√©rer le PDF pour chaque mois
      for (let mois = 0; mois < 12; mois++) {
        checkNewPage(60);
        
        // Titre du mois
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text(moisNoms[mois], margin, currentY);
        currentY += 10;
        
        // Param√®tres du tableau optimis√©s pour format paysage
        const tableHeaders = ['Date', 'N¬∞ Facture', 'Fournisseur', 'Cat√©gorie', 'Montant HT', 'Montant TTC', 'Mode paiement', 'Paiement', 'D√©ductible'];
        const colWidths = [22, 26, 40, 35, 28, 30, 28, 25, 25]; // Total = 259mm
        
        // En-t√™tes du tableau avec hauteur adaptative
        const headerRowData = tableHeaders;
        const headerRowHeight = calculerHauteurRangee(headerRowData, 10);
        
        pdf.setFillColor(240, 240, 240);
        pdf.rect(margin, currentY, usableWidth, headerRowHeight, 'F');
        
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'bold');
        
        let colX = margin;
        tableHeaders.forEach((header, i) => {
          const lignesHeader = diviserTexte(header, colWidths[i], 10);
          
          // Centrer verticalement les lignes dans la cellule
          const startY = currentY + (headerRowHeight - (lignesHeader.length * 5)) / 2 + 4;
          
          lignesHeader.forEach((ligne, j) => {
            pdf.text(ligne, colX + 3, startY + (j * 5));
          });
          
          colX += colWidths[i];
        });
        
        currentY += headerRowHeight;
        
        // Lignes de donn√©es
        const achatsMois = achatsParMois[mois];
        achatsMois.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (achatsMois.length === 0) {
          // Ligne vide si pas d'achats
          const emptyRowHeight = 10;
          
          pdf.setFont('helvetica', 'italic');
          pdf.setFontSize(10);
          
          // Centrer le texte sur toute la largeur du tableau
          const largeurTableau = colWidths.reduce((sum, width) => sum + width, 0);
          const xCentre = margin + largeurTableau / 2;
          pdf.text('Aucun achat pour ce mois', xCentre, currentY + emptyRowHeight / 2 + 2, { align: 'center' });
          
          // Bordures pour ligne vide
          pdf.setLineWidth(0.1);
          pdf.rect(margin, currentY, largeurTableau, emptyRowHeight);
          
          currentY += emptyRowHeight;
        } else {
          // Afficher les achats du mois
          achatsMois.forEach((achat, index) => {
            const dateFormatee = new Date(achat.date).toLocaleDateString('fr-FR');
            const categorieLabel = getCategorieLabel(achat.categorie);
            const modePaiementLabel = getModePaiementLabel(achat.modePaiement);
            const datePaiementFormatee = achat.datePaiement ? new Date(achat.datePaiement).toLocaleDateString('fr-FR') : 'En attente';
            const deductibleLabel = achat.deductible === 'oui' ? 'Oui' : (achat.deductible === 'non' ? 'Non' : 'Partiel');
            
            const rowData = [
              dateFormatee,
              achat.numeroFacture,
              achat.fournisseur,
              categorieLabel,
              achat.montantHT.toFixed(2) + ' ‚Ç¨',
              achat.montantTTC.toFixed(2) + ' ‚Ç¨',
              modePaiementLabel,
              datePaiementFormatee,
              deductibleLabel
            ];
            
            // Calculer la hauteur n√©cessaire pour cette rang√©e
            const rowHeight = calculerHauteurRangee(rowData, 9);
            
            checkNewPage(rowHeight + 5);
            
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            
            // Dessiner les bordures de la cellule
            pdf.setLineWidth(0.1);
            let colX = margin;
            for (let i = 0; i < colWidths.length; i++) {
              pdf.rect(colX, currentY, colWidths[i], rowHeight);
              colX += colWidths[i];
            }
            
            // Afficher le contenu de chaque cellule
            colX = margin;
            rowData.forEach((data, i) => {
              const lignesCellule = diviserTexte(data, colWidths[i], 9);
              
              // Style sp√©cial pour certaines colonnes
              if (i === 1) { // N¬∞ Facture
                pdf.setFont('helvetica', 'bold');
              } else if (data.toString().includes('‚Ç¨')) { // Montants
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);
              } else {
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);
              }
              
              // Centrer verticalement les lignes dans la cellule
              const startY = currentY + (rowHeight - (lignesCellule.length * 5)) / 2 + 4;
              
              lignesCellule.forEach((ligne, j) => {
                pdf.text(ligne, colX + 3, startY + (j * 5));
              });
              
              colX += colWidths[i];
            });
            
            currentY += rowHeight;
          });
          
          // Ligne de total pour le mois
          if (achatsMois.length > 0) {
            const totalHTMois = achatsMois.reduce((sum, a) => sum + a.montantHT, 0);
            const totalTTCMois = achatsMois.reduce((sum, a) => sum + a.montantTTC, 0);
            
            const totalData = ['', '', '', 'TOTAL MOIS', totalHTMois.toFixed(2) + ' ‚Ç¨', totalTTCMois.toFixed(2) + ' ‚Ç¨', '', '', ''];
            const totalRowHeight = calculerHauteurRangee(totalData, 10);
            
            pdf.setFillColor(245, 245, 245);
            pdf.rect(margin, currentY, usableWidth, totalRowHeight, 'F');
            
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            
            // Dessiner les bordures
            pdf.setLineWidth(0.1);
            let colX = margin;
            for (let i = 0; i < colWidths.length; i++) {
              pdf.rect(colX, currentY, colWidths[i], totalRowHeight);
              colX += colWidths[i];
            }
            
            // Afficher le contenu
            colX = margin;
            totalData.forEach((data, i) => {
              if (data) {
                const lignesCellule = diviserTexte(data, colWidths[i], 10);
                const startY = currentY + (totalRowHeight - (lignesCellule.length * 5)) / 2 + 4;
                
                lignesCellule.forEach((ligne, j) => {
                  pdf.text(ligne, colX + 3, startY + (j * 5));
                });
              }
              colX += colWidths[i];
            });
            
            currentY += totalRowHeight;
          }
        }
        
        currentY += 15;
      }
      
      // Total g√©n√©ral √† la fin
      checkNewPage(30);
      
      const totalHTGeneral = achatsAnnee.reduce((sum, a) => sum + a.montantHT, 0);
      const totalTTCGeneral = achatsAnnee.reduce((sum, a) => sum + a.montantTTC, 0);
      
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.text('R√âCAPITULATIF ANNUEL', margin, currentY);
      currentY += 10;
      
      pdf.setFontSize(10);
      pdf.text(`Total HT ${anneeAffichage} : ${totalHTGeneral.toFixed(2)} ‚Ç¨`, margin, currentY);
      currentY += 8;
      pdf.text(`Total TTC ${anneeAffichage} : ${totalTTCGeneral.toFixed(2)} ‚Ç¨`, margin, currentY);
      currentY += 8;
      pdf.text(`Nombre de factures : ${achatsAnnee.length}`, margin, currentY);
      
      // G√©n√©rer le PDF en blob
      const pdfBlob = pdf.output('blob');
      
      // Nom de fichier sugg√©r√©
      const nomFichierSuggere = `Registre_Achats_${nomEntreprise.replace(/[^a-zA-Z0-9]/g, '')}_${anneeAffichage}.pdf`;
      
      // Tentative d'utilisation de l'API File System Access (navigateurs modernes)
      if ('showSaveFilePicker' in window) {
        window.showSaveFilePicker({
          suggestedName: nomFichierSuggere,
          types: [
            {
              description: 'Fichiers PDF',
              accept: {
                'application/pdf': ['.pdf'],
              },
            },
          ],
        }).then(async (fileHandle) => {
          const writable = await fileHandle.createWritable();
          await writable.write(pdfBlob);
          await writable.close();
          
          alert('üìÑ PDF export√© avec succ√®s !');
        }).catch((err) => {
          // L'utilisateur a annul√© ou une erreur est survenue
          if (err.name !== 'AbortError') {
            console.error('Erreur lors de la sauvegarde:', err);
            // Fallback vers t√©l√©chargement normal
            telechargerPDFNormal();
          }
        });
      } else {
        // Fallback pour les navigateurs qui ne supportent pas l'API
        telechargerPDFNormal();
      }
      
      // Fonction de t√©l√©chargement normal (fallback)
      function telechargerPDFNormal() {
        const link = document.createElement('a');
        const url = URL.createObjectURL(pdfBlob);
        link.setAttribute('href', url);
        link.setAttribute('download', nomFichierSuggere);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        alert('üìÑ PDF t√©l√©charg√© dans votre dossier de t√©l√©chargements !');
      }
    }

    function viderRegistre() {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer tous les achats ? Cette action est irr√©versible.')) {
        if (confirm('Confirmation finale : tous les achats seront supprim√©s d√©finitivement.')) {
          achats = [];
          achatsFiltered = [];
          localStorage.removeItem('achats');
          afficherAchats();
          mettreAJourStatistiques();
          remplirAnnees();
          alert('Registre d\'achat vid√© avec succ√®s');
        }
      }
    }
  </script>
  <script src="../assets/js/stars-background.js"></script>
</body>
</html> 